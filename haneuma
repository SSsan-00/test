<?php
/**
 * ---------------------------------------------------------------
 *  escape.php
 *
 *  @author SS
 *  @description
 *    SQLã‚¯ã‚¨ãƒªå†…ã®æœªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¤‰æ•°ã‚’è‡ªå‹•çš„ã«sqlXXXXX()ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ãƒ„ãƒ¼ãƒ«
 *    ãƒ»ä»£å…¥ã®å³è¾ºã®å¤‰æ•°
 *    ãƒ»ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã®å¤‰æ•°
 *    ãƒ»ifæ–‡ã®ä¸€è¡Œä»£å…¥ã®å¤‰æ•°
 *    ã«å¯¾å¿œ
 * ---------------------------------------------------------------
 */

require_once __DIR__ . '/vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

/* ===============================================================
 *  å®šæ•°
 * =============================================================== */
// å‡¦ç†å¯¾è±¡ã¨ãªã‚‹å·¦è¾ºã®å¤‰æ•°åï¼ˆå°æ–‡å­—ã§æ¯”è¼ƒï¼‰
const TARGET_LHS_VARS      = ['sql', 'query', 'sql2', 'sq2', 'sql3', 'sq3'];
// å‡¦ç†å¯¾è±¡å¤–ã¨ã™ã‚‹å¤‰æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³
const EXCLUDE_VAR_PATTERNS = ['\\$sql2', '\\$sq2', '\\$sql3', '\\$sq3'];

/* ===============================================================
 *  0.  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * =============================================================== */

/**
 * æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¤‰æ›
 */
function convert_encoding(string $str, string $from = 'EUC-JP', string $to = 'UTF-8'): string
{
    if (mb_detect_encoding($str, 'UTF-8', true)) {
        return $str;
    }
    return mb_convert_encoding($str, $to, $from);
}

/**
 * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ 0-100% ã§è¡¨ç¤º
 */
function show_progress(int $current, int $total, string $msg = ''): void
{
    static $lastLen = 0;

    $rate = $total === 0 ? 0 : (int)round($current / $total * 100);
    $bar  = str_pad(str_repeat('=', $rate), 100);
    $line = "\r[{$bar}] {$rate}% " . convert_encoding($msg);
    echo $line . str_repeat(' ', max(0, $lastLen - mb_strlen($line)));
    $lastLen = mb_strlen($line);
    if ($current >= $total) echo PHP_EOL;
}

/**
 * å†å¸°çš„ã« *.php / *.inc ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†
 */
function collect_source_files(string $root): array
{
    $it = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($root, FilesystemIterator::SKIP_DOTS)
    );
    $paths = [];
    foreach ($it as $file) {
        if (\in_array($file->getExtension(), ['php', 'inc'], true)) {
            $paths[] = $file->getPathname();
        }
    }
    sort($paths);
    return $paths;
}

/**
 * $target ã‚’ $base ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã¸å¤‰æ›
 */
function relpath(string $base, string $target): string
{
    return ltrim(str_replace($base, '', $target), DIRECTORY_SEPARATOR);
}

/* ===============================================================
 *  1.  å¤‰æ•°ãƒ©ãƒƒãƒ—å‡¦ç†æœ¬ä½“
 * =============================================================== */

/**
 * å¤‰æ›å¯¾è±¡ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å®šç¾©
 * ãƒ»ä»£å…¥ã®å³è¾ºï¼ˆASSIGNMENT_RIGHTï¼‰
 * ãƒ»ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ï¼ˆHEREDOCï¼‰
 * ãƒ»ãƒŠã‚¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ï¼ˆNOWDOCï¼‰- å‡¦ç†å¯¾è±¡å¤–
 */
class ConversionContext {
    public const ASSIGNMENT_RIGHT = 'assignment_right';  // ä»£å…¥ã®å³è¾º
    public const HEREDOC = 'heredoc';                    // ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…
    public const NOWDOC = 'nowdoc';                      // ãƒŠã‚¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ï¼ˆå‡¦ç†å¯¾è±¡å¤–ï¼‰

    private static array $contexts = [
        self::ASSIGNMENT_RIGHT => true,  // å‡¦ç†å¯¾è±¡
        self::HEREDOC => true,          // å‡¦ç†å¯¾è±¡
        self::NOWDOC => false,          // å‡¦ç†å¯¾è±¡å¤–
    ];

    public static function isTarget(string $context): bool {
        return self::$contexts[$context] ?? false;
    }

    public static function addContext(string $context, bool $isTarget = true): void {
        self::$contexts[$context] = $isTarget;
    }
}

/**
 * 1 ãƒ•ã‚¡ã‚¤ãƒ«åˆ†ã®ç½®æ›ã‚’è¡Œã„ã€å¤‰æ›´è¡Œã‚’ãƒ­ã‚°ã«æ ¼ç´ã—ã¦è¿”ã™
 *
 * @param string $content å‡¦ç†å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹
 * @param string $relPath ç›¸å¯¾ãƒ‘ã‚¹ï¼ˆãƒ­ã‚°ç”¨ï¼‰
 * @param array $excludePatterns é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³
 * @param array $lhsTargets å‡¦ç†å¯¾è±¡ã®å·¦è¾ºå¤‰æ•°
 * @return array{processed:string, logRows:array<array{0:string,1:int,2:string,3:string}>}
 */
function process_file(
    string $content,
    string $relPath,
    array  $excludePatterns = EXCLUDE_VAR_PATTERNS,
    array  $lhsTargets      = TARGET_LHS_VARS
): array {
    // æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¤‰æ›ï¼ˆEUC-JP â†’ UTF-8ï¼‰
    $content = convert_encoding($content);

    // ---------- æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æº–å‚™ ----------
    //   $foo, $arr['x'], $_POST['id'] ãªã©ã®å¤‰æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³
    $varPattern = '/\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])*/u';

    // ---------- è¡Œãƒ™ãƒ¼ã‚¹ã®è§£æ ----------
    $lines  = explode("\n", $content);
    $total  = \count($lines);
    $log    = [];

    $inDoc  = false;              // HEREDOC / NOWDOCå†…éƒ¨ã‹ã©ã†ã‹
    $docEnd = '';                 // çµ‚äº†ãƒ©ãƒ™ãƒ«
    $docIsNow = false;            // NOWDOC ãƒ•ãƒ©ã‚°
    $currentContext = null;       // ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

    $lhsTargetsLC = array_map('strtolower', $lhsTargets);

    foreach ($lines as $idx => &$line) {
        // 100è¡Œã”ã¨ã«é€²æ—è¡¨ç¤º
        if ($idx % 100 === 0) show_progress($idx, $total, $relPath);

        $originalLine = $line;
        $modifiedLine = $line;

        /* ---- (1) ä»£å…¥ã®å³è¾ºåˆ¤å®š ---- */
        // ifæ–‡ã®ä¸€è¡Œä»£å…¥ã‚‚å«ã‚ã¦åˆ¤å®š
        $assignPrefix = $assignLhs = $assignOp = $assignSuffix = null;
        if (preg_match('/^(\s*(?:if\s*\([^)]+\)\s*)?)(\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])*)\s*(=|\.=)\s*(.+?)(\s*)$/u', $line, $m)) {
            [, $assignPrefix, $assignLhs, $assignOp, $rhs, $assignSuffix] = $m;
            
            $lhsName = strtolower(ltrim($assignLhs, '$'));
            if (in_array($lhsName, $lhsTargetsLC, true)) {
                $currentContext = ConversionContext::ASSIGNMENT_RIGHT;
                $modifiedLine = $rhs;
            } else {
                $currentContext = null;
            }
        }

        /* ---- (2) HEREDOC/NOWDOC é–‹å§‹åˆ¤å®š ---- */
        // ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®é–‹å§‹è¡Œã‚’æ¤œå‡º
        if (!$inDoc &&
            preg_match('/^\s*(\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*)?\s*(=|\.=)?\s*<<<(?P<q>[\'"]?)(?P<label>[A-Za-z_][A-Za-z0-9_]*)\k<q>/u', $line, $m)
        ) {
            $lhsName = isset($m[1]) ? strtolower(ltrim($m[1], '$')) : '';
            $docIsTarget = in_array($lhsName, $lhsTargetsLC, true);
            $inDoc = true;
            $docEnd = $m['label'];
            $docIsNow = ($m['q'] === '\'');
            // å·¦è¾ºã®å¤‰æ•°åãŒå¯¾è±¡ã®å ´åˆã®ã¿å‡¦ç†
            $currentContext = $docIsNow ? ConversionContext::NOWDOC : ($docIsTarget ? ConversionContext::HEREDOC : null);
            // é–‹å§‹è¡Œã‚’ä¿æŒï¼ˆå¤‰æ•°åã‚’å«ã‚€ï¼‰
            $line = $originalLine;
        }

        /* ---- (3) HEREDOC/NOWDOC çµ‚äº†åˆ¤å®š ---- */
        // ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®çµ‚äº†è¡Œã‚’æ¤œå‡º
        if ($inDoc && preg_match('/^' . preg_quote($docEnd, '/') . ';?\s*$/', trim($line))) {
            $inDoc = false;
            $line = $docEnd;  // çµ‚äº†ãƒ©ãƒ™ãƒ«ã®ã¿ã‚’ä¿æŒ
            $docEnd = '';
            $docIsNow = false;
            $currentContext = null;
            continue;
        }

        /* ---- (4) å¤‰æ›å¯¾è±¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã®ã¿å‡¦ç† ---- */
        if ($currentContext && ConversionContext::isTarget($currentContext)) {
            /* ---- (4-1) 1 è¡Œå†…ã®å¤‰æ•°å€™è£œã‚’æŠ½å‡º ---- */
            preg_match_all($varPattern, $modifiedLine, $matches);
            $candidates = array_unique($matches[0]);

            foreach ($candidates as $var) {
                // a) é™¤å¤–ãƒªã‚¹ãƒˆã«ä¸€è‡´ã™ã‚‹å¤‰æ•°ã¯ã‚¹ã‚­ãƒƒãƒ—
                foreach ($excludePatterns as $pat) {
                    if (preg_match('/^' . $pat . '$/u', $var)) {
                        continue 2;   // å¤–å´ foreach ($candidates...) ã¸
                    }
                }

                // b) æ—¢ã« sql*() ã§åŒ…ã¾ã‚Œã¦ã„ã‚‹å¤‰æ•°ã¯ã‚¹ã‚­ãƒƒãƒ—
                $alreadyWrapped = preg_match(
                    '/sql\w+\s*\(\s*' . preg_quote($var, '/') . '\s*\)/ui',
                    $modifiedLine
                );
                if ($alreadyWrapped) continue;

                /* ---- (4-2) ãƒ–ãƒ¬ãƒ¼ã‚¹ä»˜ãå¤‰æ•° "{$var}" ã¸ã®ç‰¹åˆ¥å¯¾å¿œ ---- */
                $braced = '\{\$' . preg_quote(ltrim($var, '$'), '/') . '\}';
                if (preg_match('/"' . $braced . '"/u', $modifiedLine)) {
                    $modifiedLine = preg_replace(
                        '/"' . $braced . '"/u',
                        'sqlXXXXX({$0})',   // {$0} = {$var}
                        $modifiedLine
                    );
                    continue;
                }

                /* ---- (4-3) é€šå¸¸ã®å¤‰æ•° $var ã‚’ãƒ©ãƒƒãƒ— ---- */
                $modifiedLine = preg_replace(
                    '/(?<![A-Za-z0-9_\x80-\xff])' . preg_quote($var, '/') . '(?![A-Za-z0-9_\x80-\xff])/u',
                    'sqlXXXXX(' . $var . ')',
                    $modifiedLine
                );
            }
        }

        /* ---- (5) ä»£å…¥ã®å³è¾ºã‚’å…ƒã®è¡Œã«æˆ»ã™ ---- */
        if ($currentContext === ConversionContext::ASSIGNMENT_RIGHT) {
            // å–å¾—æ¸ˆã¿ã®å„è¦ç´ ã§å†æ§‹ç¯‰ï¼ˆifæ–‡ã®ä¸€è¡Œä»£å…¥ã‚‚æ­£ã—ãå‡¦ç†ï¼‰
            $line = $assignPrefix . $assignLhs . ' ' . $assignOp . ' ' . $modifiedLine . $assignSuffix;
        } else {
            $line = $modifiedLine;
        }

        /* ---- (6) ãƒ­ã‚°è¨˜éŒ² ---- */
        if ($originalLine !== $line) {
            // sqlXXXXXãŒå«ã¾ã‚Œã‚‹è¡Œã®ã¿ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
            if (strpos($line, 'sqlXXXXX') !== false) {
                $log[] = [
                    convert_encoding($relPath),
                    $idx + 1,
                    convert_encoding($originalLine),
                    convert_encoding($line)
                ];
            }
        }
    }
    // é€²æ—å®Œäº†
    show_progress($total, $total, $relPath);

    return ['processed' => implode("\n", $lines), 'logRows' => $log];
}

/* ===============================================================
 *  2.  CLI ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 * =============================================================== */

function main(array $argv = []): void
{
    if (count($argv) < 2) {
        // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (defined('PHPUNIT_COMPOSER_INSTALL') || empty($argv)) {
            return;
        }
        
        fwrite(STDERR, "ä½¿ç”¨æ–¹æ³•: php escape.php <scan_dir>\n");
        exit(1);
    }

    [$self, $scanDir] = $argv;
    $scanDir   = realpath($scanDir) ?: $scanDir;
    $outputDir = __DIR__ . '/escapedAiriku';
    if (!is_dir($outputDir)) mkdir($outputDir, 0777, true);

    /* ---------- åé›† ---------- */
    echo "ğŸ“‚ ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡: {$scanDir}\n";
    $files = collect_source_files($scanDir);
    echo "   â†’ " . \count($files) . " ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹\n";

    /* ---------- ä¸Šæ›¸ãç¢ºèª ---------- */
    $relFiles = array_map(fn($f) => relpath($scanDir, $f), $files);
    $overwrite = check_existing_files($outputDir, $relFiles);
    if (!$overwrite) {
        echo "ğŸš« ä¸­æ­¢ã—ã¾ã—ãŸ\n";
        return;
    }

    /* ---------- ç½®æ›å‡¦ç† ---------- */
    $start = microtime(true);
    $allLogs = [];
    foreach ($files as $index => $path) {
        $rel = relpath($scanDir, $path);
        $src = file_get_contents($path);
        ['processed' => $dst, 'logRows' => $rows] = process_file($src, $rel);

        // å·®åˆ†ã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›
        $outPath = $outputDir . DIRECTORY_SEPARATOR . $rel;
        if (!is_dir(dirname($outPath))) {
            mkdir(dirname($outPath), 0777, true);
        }
        file_put_contents($outPath, $dst);
        if ($rows) {
            $allLogs = array_merge($allLogs, $rows);
        }
    }

    /* ---------- Excel ãƒ­ã‚° ---------- */
    echo "\nğŸ“‘ Excel ãƒ­ã‚°ã‚’ä½œæˆä¸­...\n";
    $logName = export_excel_log($allLogs);

    /* ---------- çµ‚äº†é€šçŸ¥ ---------- */
    $elapsed = round(microtime(true) - $start, 2);
    echo "âœ… å®Œäº† (å‡¦ç†æ™‚é–“: {$elapsed}s)\n";
    echo "   ãƒ»å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°: " . \count(array_unique(array_column($allLogs, 0))) . "\n";
    echo "   ãƒ»Excel ãƒ­ã‚°        : {$logName}\n";
}

/* ===============================================================
 *  å®Ÿè¡Œ
 * =============================================================== */
// PHPUnitã‹ã‚‰ã®å®Ÿè¡Œæ™‚ã¯è‡ªå‹•å®Ÿè¡Œã—ãªã„
if (!defined('PHPUNIT_COMPOSER_INSTALL')) {
    main($argv);
}

/* ---------------------------------------------------------------
 *  è£œåŠ©é–¢æ•°  : check_existing_files
 * --------------------------------------------------------------- */
function check_existing_files(string $outDir, array $relPaths): bool
{
    $dupes = [];
    foreach ($relPaths as $p) {
        $outPath = $outDir . DIRECTORY_SEPARATOR . $p;
        if (is_file($outPath)) $dupes[] = $p;
    }
    if (!$dupes) return true;

    echo "âš ï¸  æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ (è¨ˆ " . count($dupes) . ")\n";
    foreach ($dupes as $p) echo "   - {$p}\n";
    echo "ä¸Šæ›¸ãã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ (yes/no): ";
    $ans = trim(fgets(STDIN));
    return strtolower($ans) === 'yes';
}

/* ===============================================================
 *  2. Excel ãƒ­ã‚°å‡ºåŠ›
 * =============================================================== */
/**
 * å¤‰æ›´ãƒ­ã‚°ã‚’Excelãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹
 * 
 * PhpSpreadsheetãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€å¤‰æ›´å†…å®¹ã‚’Excelãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›
 * å‡ºåŠ›ã•ã‚Œã‚‹Excelãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ä»¥ä¸‹ã®åˆ—ãŒå«ã¾ã‚Œã‚‹
 * - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼šå¤‰æ›´ãŒè¡Œã‚ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç›¸å¯¾ãƒ‘ã‚¹
 * - è¡Œç•ªå·ï¼šå¤‰æ›´ãŒè¡Œã‚ã‚ŒãŸè¡Œç•ªå·
 * - å¤‰æ›´å‰ï¼šå…ƒã®ã‚³ãƒ¼ãƒ‰è¡Œ
 * - å¤‰æ›´å¾Œï¼šsqlXXXXX()ã§ãƒ©ãƒƒãƒ—ã•ã‚ŒãŸå¾Œã®ã‚³ãƒ¼ãƒ‰è¡Œ
 * 
 * @param array $rows å¤‰æ›´ãƒ­ã‚°ã®é…åˆ—
 *                   å„è¦ç´ ã¯ [ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹, è¡Œç•ªå·, å¤‰æ›´å‰, å¤‰æ›´å¾Œ] ã®å½¢å¼
 * @return string ç”Ÿæˆã•ã‚ŒãŸExcelãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ï¼ˆlog_YYYYMMDD_HHMMSS.xlsxå½¢å¼ï¼‰
 * 
 * @uses PhpOffice\PhpSpreadsheet\Spreadsheet
 * @uses PhpOffice\PhpSpreadsheet\Writer\Xlsx
 */
function export_excel_log(array $rows): string
{
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¿½åŠ 
    $data    = [['ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹', 'è¡Œç•ªå·', 'å¤‰æ›´å‰', 'å¤‰æ›´å¾Œ']];
    $data    = array_merge($data, $rows);
    $logName = 'log_' . date('Ymd_His') . '.xlsx';

    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆã¨è¨­å®š
    $wb = new Spreadsheet();
    $ws = $wb->getActiveSheet();
    $ws->fromArray($data, null, 'A1', true);
    $ws->setTitle('Log', false);

    // Excelãƒ•ã‚¡ã‚¤ãƒ«ã®å‡ºåŠ›
    $writer = new Xlsx($wb);
    $writer->setPreCalculateFormulas(false);  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    $writer->save($logName);

    // ãƒ¡ãƒ¢ãƒªè§£æ”¾
    $wb->disconnectWorksheets();
    unset($wb);

    return $logName;
}
