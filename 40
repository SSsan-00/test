<?php

use PhpParser\Error;
use PhpParser\NodeTraverser;
use PhpParser\NodeVisitor\NameResolver;
use PhpParser\ParserFactory;

/**
 * SQLé™çš„è§£æãƒ„ãƒ¼ãƒ«ã®ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
 * 
 * ã“ã®ã‚¯ãƒ©ã‚¹ã¯ä»¥ä¸‹ã®å‡¦ç†ã‚’æ‹…å½“ã—ã¾ã™ï¼š
 * 1. ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
 *    - å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†å¸°çš„ãªèµ°æŸ»
 *    - PHPãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
 *    - ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿
 * 
 * 2. ã‚³ãƒ¼ãƒ‰è§£æ
 *    - PHPParserã‚’ä½¿ç”¨ã—ãŸASTè§£æ
 *    - é–¢æ•°ãƒ»ã‚¯ãƒ©ã‚¹å®šç¾©ã®æŠ½å‡º
 *    - æ–‡å­—åˆ—é€£çµã®å‡¦ç†
 *    - å¤‰æ•°ãƒ»å®šæ•°ã®è§£æ±º
 *    - SQLã‚¯ã‚¨ãƒªã®æŠ½å‡ºã¨è§£æ
 * 
 * 3. è§£æçµæœã®ç®¡ç†
 *    - ãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ã§ã®çµæœæ•´ç†
 *    - é–¢æ•°å˜ä½ã§ã®çµæœæ•´ç†
 *    - ãƒ†ãƒ¼ãƒ–ãƒ«å˜ä½ã§ã®æ“ä½œï¼ˆCRUDï¼‰ã®é›†ç´„
 *    - çµæœã®ãƒãƒ¼ã‚¸ã¨é‡è¤‡æ’é™¤
 * 
 * 4. ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
 *    - ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè¡Œ
 *    - ãƒ†ã‚¹ãƒˆçµæœã®é›†è¨ˆ
 *    - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬
 *    - è©³ç´°ãªãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 * 
 * 5. ã‚¨ã‚¯ã‚»ãƒ«å‡ºåŠ›
 *    - è§£æçµæœã®ã‚¨ã‚¯ã‚»ãƒ«å½¢å¼ã¸ã®å¤‰æ›
 *    - ã‚·ãƒ¼ãƒˆã®ä½œæˆã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 *    - çµæœã®ä¿å­˜
 * 
 * 6. ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
 *    - è©³ç´°ãªå‡¦ç†ãƒ­ã‚°
 *    - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ç›£è¦–
 *    - é€²æ—çŠ¶æ³ã®è¡¨ç¤º
 *    - ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
 */
class SqlAnalyzer {
    /**
     * @var FileProcessor ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¯ãƒ©ã‚¹
     */
    private $fileProcessor;
    
    /**
     * @var StringProcessor æ–‡å­—åˆ—å‡¦ç†ã‚¯ãƒ©ã‚¹
     */
    private $stringProcessor;
    
    /**
     * @var QueryParser ã‚¯ã‚¨ãƒªè§£æã‚¯ãƒ©ã‚¹
     */
    private $queryParser;
    
    /**
     * @var ExcelExporter ã‚¨ã‚¯ã‚»ãƒ«å‡ºåŠ›ã‚¯ãƒ©ã‚¹
     */
    private $excelExporter;
    
    /**
     * @var array è§£æçµæœ
     */
    private $results = [];
    
    /**
     * @var array ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆ
     */
    private $views = [];
    
    /**
     * @var bool è©³ç´°å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰
     */
    private $verbose = false;
    
    /**
     * @var \PhpParser\Parser PHPParser
     */
    private $parser;
    
    /**
     * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
     * 
     * @param bool $verbose è©³ç´°å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰
     */
    public function __construct($verbose = false) {
        $this->verbose = $verbose;
        
        // ä¾å­˜ã‚¯ãƒ©ã‚¹ã‚’åˆæœŸåŒ–
        $this->fileProcessor = new FileProcessor($verbose);
        $this->stringProcessor = new StringProcessor($verbose);
        $this->queryParser = new QueryParser([], $verbose);
        $this->excelExporter = new ExcelExporter($verbose);
        
        // ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        $this->views = $this->fileProcessor->loadViews();
        
        // ã‚¯ã‚¨ãƒªè§£æå™¨ã«ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã‚’è¨­å®š
        $this->queryParser = new QueryParser($this->views, $verbose);
        
        // PHPParserã®åˆæœŸåŒ–
        if (class_exists('PhpParser\ParserFactory')) {
            $parserFactory = new ParserFactory;
            $this->parser = $parserFactory->createForNewestSupportedVersion();
        }
    }
    
    /**
     * è§£æã‚’å®Ÿè¡Œ
     * 
     * @param string $targetDir è§£æå¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
     * @return bool æˆåŠŸã—ãŸã‹ã©ã†ã‹
     */
    public function analyze($targetDir) {
        // è§£æé–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        $this->showProgress("SQLé™çš„è§£æã‚’é–‹å§‹ã—ã¾ã™: {$targetDir}");
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®å–å¾—
        $this->showProgress("å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­...");
        $files = $this->fileProcessor->findFiles($targetDir, ['php', 'inc', 'html', 'js']);
        
        if (empty($files)) {
            $this->showProgress("ã‚¨ãƒ©ãƒ¼: è§£æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
            return false;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’è¨­å®š
        $this->fileProcessor->setTotalFiles(count($files));
        $this->showProgress("è§£æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°: " . $this->fileProcessor->getTotalFiles());
        
        // å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
        foreach ($files as $filePath) {
            $this->analyzeFile($filePath);
            $this->fileProcessor->updateProgress(basename($filePath));
        }
        
        // çµæœã‚’å‡ºåŠ›
        $this->showProgress("å‡¦ç†å®Œäº†: " . $this->fileProcessor->getProcessedFiles() . " ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã¾ã—ãŸ");
        
        // ã‚¨ã‚¯ã‚»ãƒ«å‡ºåŠ›
        if (!empty($this->results)) {
            $this->showProgress("ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ä¸­...");
            $filepath = $this->excelExporter->export($this->results, $this->views);
            $this->showProgress("ã‚¨ã‚¯ã‚»ãƒ«å‡ºåŠ›å®Œäº†: {$filepath}");
        } else {
            $this->showProgress("çµæœãŒç©ºã®ãŸã‚ã€ã‚¨ã‚¯ã‚»ãƒ«å‡ºåŠ›ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™");
        }
        
        return true;
    }
    
    /**
     * æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
     * 
     * @param string $filePath ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
     */
    private function analyzeFile($filePath) {
        // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®åˆæœŸå€¤ã‚’è¨˜éŒ²
        $initialMemory = memory_get_usage();
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’å–å¾—
        $code = $this->fileProcessor->readFile($filePath);
        if ($code === null) {
            return;
        }
        
        // é€²æ—è¡¨ç¤º
        $this->showProgress("è§£æä¸­: " . basename($filePath));
        
        // PHPParserã‚’ä½¿ç”¨ã—ã¦é–¢æ•°è§£æãŒå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        if ($this->parser !== null) {
            try {
                $this->analyzeWithParser($code, $filePath);
            } catch (Error $e) {
                $this->showProgress("PHPParserã«ã‚ˆã‚‹è§£æã«å¤±æ•—: " . $e->getMessage() . " æ­£è¦è¡¨ç¾ãƒ™ãƒ¼ã‚¹ã®è§£æã«åˆ‡ã‚Šæ›¿ãˆã¾ã™");
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å¾“æ¥ã®æ–¹æ³•ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                $this->analyzeWithRegex($code, $filePath);
            }
        } else {
            // PHPParserãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯æ­£è¦è¡¨ç¾ãƒ™ãƒ¼ã‚¹ã§è§£æ
            $this->analyzeWithRegex($code, $filePath);
        }
        
        // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å¤‰åŒ–ã‚’è¡¨ç¤º
        $currentMemory = memory_get_usage();
        $memoryDiff = $currentMemory - $initialMemory;
        $this->showProgress("ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: " . round($memoryDiff / 1024 / 1024, 2) . "MB");
    }
    
    /**
     * PHPParserã‚’ä½¿ç”¨ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«è§£æ
     * 
     * @param string $code ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹
     * @param string $filePath ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
     */
    private function analyzeWithParser($code, $filePath) {
        // PHPã‚¿ã‚°ãŒçœç•¥ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¿½åŠ 
        if (strpos($code, '<?php') === false && strpos($code, '<?=') === false) {
            $code = '<?php ' . $code;
        }
        
        try {
            // ASTã¸ã®ãƒ‘ãƒ¼ã‚¹
            $ast = $this->parser->parse($code);
            
            // åå‰è§£æ±ºã¨å®šæ•°è§£æ±ºã®ãŸã‚ã®ãƒ“ã‚¸ã‚¿ãƒ¼è¿½åŠ 
            $nameResolver = new NameResolver();
            $traverser = new NodeTraverser();
            $traverser->addVisitor($nameResolver);
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ“ã‚¸ã‚¿ãƒ¼ã‚’è¿½åŠ ã—ã¦å¤‰æ•°ã®è¿½è·¡ã¨è§£æ±ºã‚’è¡Œã†
            $variableCollector = new class($this->verbose) extends \PhpParser\NodeVisitorAbstract {
                private $variables = [];
                private $constants = [];
                private $verbose;
                
                public function __construct($verbose) {
                    $this->verbose = $verbose;
                }
                
                public function enterNode(\PhpParser\Node $node) {
                    // å¤‰æ•°ä»£å…¥ã®åé›†
                    if ($node instanceof \PhpParser\Node\Expr\Assign) {
                        if ($node->var instanceof \PhpParser\Node\Expr\Variable) {
                            $varName = $node->var->name;
                            if (is_string($varName)) {
                                if ($node->expr instanceof \PhpParser\Node\Scalar\String_) {
                                    $this->variables[$varName] = $node->expr->value;
                                } else if ($node->expr instanceof \PhpParser\Node\Scalar\LNumber) {
                                    $this->variables[$varName] = (string)$node->expr->value;
                                } else if ($node->expr instanceof \PhpParser\Node\Scalar\DNumber) {
                                    $this->variables[$varName] = (string)$node->expr->value;
                                }
                            }
                        }
                    }
                    // å®šæ•°å®šç¾©ã®åé›†
                    else if ($node instanceof \PhpParser\Node\Expr\FuncCall) {
                        if ($node->name instanceof \PhpParser\Node\Name && $node->name->toString() === 'define') {
                            if (isset($node->args[0]) && isset($node->args[1])) {
                                $arg0 = $node->args[0]->value;
                                $arg1 = $node->args[1]->value;
                                
                                if ($arg0 instanceof \PhpParser\Node\Scalar\String_ && 
                                    $arg1 instanceof \PhpParser\Node\Scalar\String_) {
                                    $this->constants[$arg0->value] = $arg1->value;
                                }
                            }
                        }
                    }
                    // constå®£è¨€ã®åé›†
                    else if ($node instanceof \PhpParser\Node\Stmt\Const_) {
                        foreach ($node->consts as $const) {
                            if ($const->value instanceof \PhpParser\Node\Scalar\String_) {
                                $this->constants[$const->name->toString()] = $const->value->value;
                            }
                        }
                    }
                }
                
                public function getVariables() {
                    return $this->variables;
                }
                
                public function getConstants() {
                    return $this->constants;
                }
            };
            
            $traverser->addVisitor($variableCollector);
            $ast = $traverser->traverse($ast);
            
            // é–¢æ•°ã¨ã‚¯ãƒ©ã‚¹å®šç¾©ã®åˆ†æ
            $this->analyzeFunctionsAndClasses($ast, $filePath);
            
            // æ–‡å­—åˆ—é€£çµã¨å¤‰æ•°è§£æ±ºã‚’è¡Œã†
            list($processedCode, $unresolved) = $this->stringProcessor->process($code);
            
            // å‡¦ç†ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            $this->stringProcessor->checkProcessedCode($processedCode, basename($filePath));
            
            // ã‚¯ã‚¨ãƒªãƒ‘ãƒ¼ã‚µãƒ¼ã«æœªè§£æ±ºå¤‰æ•°ãƒ»å®šæ•°ã‚’è¨­å®š
            $this->queryParser->setUnresolved($unresolved);
            
            // å¤‰æ•°ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã‹ã‚‰åé›†ã—ãŸå¤‰æ•°ã¨å®šæ•°ã‚‚è¨­å®š
            $this->stringProcessor->addCollectedVariables($variableCollector->getVariables());
            $this->stringProcessor->addCollectedConstants($variableCollector->getConstants());
            
            // SQLã‚¯ã‚¨ãƒªã®è§£æï¼ˆé–¢æ•°å¤–ã®ã‚³ãƒ¼ãƒ‰ã‚’'main'ã¨ã—ã¦æ‰±ã†ï¼‰
            $results = $this->queryParser->parseQueries($processedCode, 'main', basename($filePath));
            
            // çµæœã‚’ãƒãƒ¼ã‚¸
            $this->mergeResults($results);
            
        } catch (Error $e) {
            $this->showProgress("PHPParserã«ã‚ˆã‚‹è§£æã«å¤±æ•—: " . $e->getMessage() . " æ­£è¦è¡¨ç¾ãƒ™ãƒ¼ã‚¹ã®è§£æã«åˆ‡ã‚Šæ›¿ãˆã¾ã™");
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å¾“æ¥ã®æ–¹æ³•ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            $this->analyzeWithRegex($code, $filePath);
        }
    }
    
    /**
     * ASTã‹ã‚‰é–¢æ•°ã¨ã‚¯ãƒ©ã‚¹ã‚’è§£æ
     * 
     * @param array $ast æŠ½è±¡æ§‹æ–‡æœ¨
     * @param string $filePath ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
     */
    private function analyzeFunctionsAndClasses($ast, $filePath) {
        foreach ($ast as $node) {
            $this->analyzeNode($node, basename($filePath));
        }
    }
    
    /**
     * ãƒãƒ¼ãƒ‰ã‚’è§£æï¼ˆå†å¸°çš„ã«å‡¦ç†ï¼‰
     *
     * @param \PhpParser\Node $node è§£æå¯¾è±¡ãƒãƒ¼ãƒ‰
     * @param string $filePath ãƒ•ã‚¡ã‚¤ãƒ«å
     */
    private function analyzeNode($node, $filePath) {
        // é–¢æ•°å®šç¾©
        if ($node instanceof \PhpParser\Node\Stmt\Function_) {
            $this->analyzeFunctionNode($node, $filePath);
        }
        // ã‚¯ãƒ©ã‚¹å®šç¾©
        else if ($node instanceof \PhpParser\Node\Stmt\Class_) {
            $this->analyzeClassNode($node, $filePath);
        }
        // ä»–ã®ãƒãƒ¼ãƒ‰å†…ã®å­ãƒãƒ¼ãƒ‰ã‚‚å†å¸°çš„ã«å‡¦ç†
        else if ($node instanceof \PhpParser\Node\Stmt\Class_ || 
                 $node instanceof \PhpParser\Node\Stmt\Function_ ||
                 $node instanceof \PhpParser\Node\Stmt\Namespace_) {
            foreach ($node->stmts as $subNode) {
                $this->analyzeNode($subNode, $filePath);
            }
        }
    }
    
    /**
     * é–¢æ•°å®šç¾©ãƒãƒ¼ãƒ‰ã‚’è§£æ
     *
     * @param \PhpParser\Node\Stmt\Function_ $node é–¢æ•°å®šç¾©ãƒãƒ¼ãƒ‰
     * @param string $filePath ãƒ•ã‚¡ã‚¤ãƒ«å
     */
    private function analyzeFunctionNode($node, $filePath) {
        $functionName = $node->name->toString();
        $stmts = $node->getStmts();
        
        // é–¢æ•°å†…ã®å„æ–‡ã‚’é€£çµã—ã¦ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆ
        $functionCode = '';
        foreach ($stmts as $stmt) {
            $functionCode .= $this->getNodeCode($stmt);
        }
        
        // æ–‡å­—åˆ—é€£çµã¨å¤‰æ•°è§£æ±ºã‚’è¡Œã†
        list($processedCode, $unresolved) = $this->stringProcessor->process($functionCode);
        
        // ã‚¯ã‚¨ãƒªãƒ‘ãƒ¼ã‚µãƒ¼ã«æœªè§£æ±ºå¤‰æ•°ãƒ»å®šæ•°ã‚’è¨­å®š
        $this->queryParser->setUnresolved($unresolved);
        
        // é–¢æ•°å†…ã®SQLã‚¯ã‚¨ãƒªã‚’è§£æ
        $results = $this->queryParser->parseQueries($processedCode, $functionName, $filePath);
        
        // çµæœã‚’ãƒãƒ¼ã‚¸
        $this->mergeResults($results);
    }
    
    /**
     * ã‚¯ãƒ©ã‚¹å®šç¾©ãƒãƒ¼ãƒ‰ã‚’è§£æ
     *
     * @param \PhpParser\Node\Stmt\Class_ $node ã‚¯ãƒ©ã‚¹å®šç¾©ãƒãƒ¼ãƒ‰
     * @param string $filePath ãƒ•ã‚¡ã‚¤ãƒ«å
     */
    private function analyzeClassNode($node, $filePath) {
        $className = $node->name->toString();
        
        // ã‚¯ãƒ©ã‚¹å†…ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å–å¾—
        foreach ($node->getMethods() as $method) {
            $methodName = $method->name->toString();
            $isStatic = $method->isStatic();
            $fullMethodName = $methodName;
            
            // ãƒ¡ã‚½ãƒƒãƒ‰å†…ã®å„æ–‡ã‚’é€£çµã—ã¦ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆ
            $methodCode = '';
            foreach ($method->getStmts() as $stmt) {
                $methodCode .= $this->getNodeCode($stmt);
            }
            
            // æ–‡å­—åˆ—é€£çµã¨å¤‰æ•°è§£æ±ºã‚’è¡Œã†
            list($processedCode, $unresolved) = $this->stringProcessor->process($methodCode);
            
            // ã‚¯ã‚¨ãƒªãƒ‘ãƒ¼ã‚µãƒ¼ã«æœªè§£æ±ºå¤‰æ•°ãƒ»å®šæ•°ã‚’è¨­å®š
            $this->queryParser->setUnresolved($unresolved);
            
            // ãƒ¡ã‚½ãƒƒãƒ‰å†…ã®SQLã‚¯ã‚¨ãƒªã‚’è§£æ
            $results = $this->queryParser->parseQueries($processedCode, $fullMethodName, $filePath);
            
            // çµæœã‚’ãƒãƒ¼ã‚¸
            $this->mergeResults($results);
        }
    }
    
    /**
     * ãƒãƒ¼ãƒ‰ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
     *
     * @param \PhpParser\Node\Stmt|\PhpParser\Node\Expr $node ãƒãƒ¼ãƒ‰
     * @return string ã‚³ãƒ¼ãƒ‰
     */
    private function getNodeCode($node) {
        // ãƒãƒ¼ãƒ‰ã«è©²å½“ã™ã‚‹éƒ¨åˆ†ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        if ($node instanceof \PhpParser\Node\Expr\Assign) {
            // ä»£å…¥ãƒãƒ¼ãƒ‰ã®å‡¦ç†
            if ($node->var instanceof \PhpParser\Node\Expr\Variable && 
                $node->expr instanceof \PhpParser\Node\Scalar\String_) {
                return '$' . $node->var->name . ' = "' . $node->expr->value . '";';
            } elseif ($node->var instanceof \PhpParser\Node\Expr\Variable && 
                     $node->expr instanceof \PhpParser\Node\Scalar\LNumber) {
                return '$' . $node->var->name . ' = ' . $node->expr->value . ';';
            } elseif ($node->var instanceof \PhpParser\Node\Expr\Variable && 
                     $node->expr instanceof \PhpParser\Node\Scalar\DNumber) {
                return '$' . $node->var->name . ' = ' . $node->expr->value . ';';
            }
        } elseif ($node instanceof \PhpParser\Node\Stmt\Expression) {
            // å¼ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã®å ´åˆã€å¼è‡ªä½“ã‚’å–å¾—
            return $this->getNodeCode($node->expr) . ';';
        } elseif ($node instanceof \PhpParser\Node\Expr\BinaryOp\Concat) {
            // æ–‡å­—åˆ—é€£çµã®å ´åˆ
            $left = $this->getNodeCode($node->left);
            $right = $this->getNodeCode($node->right);
            return $left . ' . ' . $right;
        }
        
        // PrettyPrinterã‚’ä½¿ã£ã¦ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ï¼‰
        try {
            $prettyPrinter = new \PhpParser\PrettyPrinter\Standard();
            return $prettyPrinter->prettyPrint([$node]);
        } catch (\Exception $e) {
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ç©ºæ–‡å­—åˆ—ã‚’è¿”ã™
            $this->showProgress("ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å–å¾—ã‚¨ãƒ©ãƒ¼: " . $e->getMessage());
            return '';
        }
    }
    
    /**
     * æ­£è¦è¡¨ç¾ãƒ™ãƒ¼ã‚¹ã®è§£æ
     * 
     * @param string $code ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹
     * @param string $filePath ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
     */
    private function analyzeWithRegex($code, $filePath) {
        // æ–‡å­—åˆ—é€£çµã¨å¤‰æ•°è§£æ±ºã‚’è¡Œã†
        list($processedCode, $unresolved) = $this->stringProcessor->process($code);
        
        // å‡¦ç†ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        $this->stringProcessor->checkProcessedCode($processedCode, basename($filePath));
        
        // ã‚¯ã‚¨ãƒªãƒ‘ãƒ¼ã‚µãƒ¼ã«æœªè§£æ±ºå¤‰æ•°ãƒ»å®šæ•°ã‚’è¨­å®š
        $this->queryParser->setUnresolved($unresolved);
        
        // é–¢æ•°å®šç¾©ã‚’æ¤œå‡º
        preg_match_all('/function\s+([a-zA-Z0-9_]+)\s*\([^)]*\)\s*\{(.*?)\}/s', $processedCode, $functionMatches, PREG_SET_ORDER);
        
        // ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ã‚’æ¤œå‡º
        preg_match_all('/class\s+([a-zA-Z0-9_]+).*?\{(.*?)\}/s', $processedCode, $classMatches, PREG_SET_ORDER);
        
        // é–¢æ•°å¤–ã®ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’æŠ½å‡º
        $mainCode = $processedCode;
        foreach ($functionMatches as $match) {
            $mainCode = str_replace($match[0], '', $mainCode);
        }
        foreach ($classMatches as $match) {
            $mainCode = str_replace($match[0], '', $mainCode);
        }
        
        // é–¢æ•°å®šç¾©ã”ã¨ã«SQLã‚¯ã‚¨ãƒªè§£æ
        foreach ($functionMatches as $match) {
            $functionName = $match[1];
            $functionBody = $match[2];
            
            // é–¢æ•°å†…ã®SQLã‚¯ã‚¨ãƒªã‚’è§£æ
            $results = $this->queryParser->parseQueries($functionBody, $functionName, basename($filePath));
            
            // çµæœã‚’ãƒãƒ¼ã‚¸
            $this->mergeResults($results);
        }
        
        // ã‚¯ãƒ©ã‚¹å†…ã®ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ã‚’æ¤œå‡ºã—ã¦è§£æ
        foreach ($classMatches as $classMatch) {
            $className = $classMatch[1];
            $classBody = $classMatch[2];
            
            // ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ã‚’æ¤œå‡º
            preg_match_all('/(public|private|protected|static)?\s*function\s+([a-zA-Z0-9_]+)\s*\([^)]*\)\s*\{(.*?)\}/s', $classBody, $methodMatches, PREG_SET_ORDER);
            
            foreach ($methodMatches as $methodMatch) {
                $methodName = $methodMatch[2];
                $methodBody = $methodMatch[3];
                
                // ãƒ¡ã‚½ãƒƒãƒ‰å†…ã®SQLã‚¯ã‚¨ãƒªã‚’è§£æ
                $results = $this->queryParser->parseQueries($methodBody, $methodName, basename($filePath));
                
                // çµæœã‚’ãƒãƒ¼ã‚¸
                $this->mergeResults($results);
            }
        }
        
        // é–¢æ•°å¤–ã®ã‚³ãƒ¼ãƒ‰ï¼ˆmainæ‰±ã„ï¼‰ã®SQLã‚¯ã‚¨ãƒªè§£æ
        $results = $this->queryParser->parseQueries($mainCode, 'main', basename($filePath));
        
        // çµæœã‚’ãƒãƒ¼ã‚¸
        $this->mergeResults($results);
    }
    
    /**
     * çµæœã‚’ãƒãƒ¼ã‚¸ã™ã‚‹
     * 
     * @param array $newResults æ–°ã—ã„çµæœ
     */
    private function mergeResults($newResults) {
        foreach ($newResults as $filePath => $functions) {
            if (!isset($this->results[$filePath])) {
                $this->results[$filePath] = [];
            }
            
            foreach ($functions as $functionName => $tables) {
                if (!isset($this->results[$filePath][$functionName])) {
                    $this->results[$filePath][$functionName] = [];
                }
                
                foreach ($tables as $tableName => $operations) {
                    if (!isset($this->results[$filePath][$functionName][$tableName])) {
                        $this->results[$filePath][$functionName][$tableName] = [];
                    }
                    
                    $this->results[$filePath][$functionName][$tableName] = array_merge(
                        $this->results[$filePath][$functionName][$tableName],
                        $operations
                    );
                    
                    // é‡è¤‡ã‚’æ’é™¤
                    $this->results[$filePath][$functionName][$tableName] = array_unique(
                        $this->results[$filePath][$functionName][$tableName]
                    );
                }
            }
        }
    }
    
    /**
     * ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ¡ã‚½ãƒƒãƒ‰
     * 
     * @param string $testDir ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
     * @return array ãƒ†ã‚¹ãƒˆçµæœ
     */
    public function runTests($testDir) {
        // çµæœã‚’ãƒªã‚»ãƒƒãƒˆ
        $this->results = [];
        
        // ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        $this->showProgress("SQLé™çš„è§£æãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™: {$testDir}");
        
        // ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
        $files = $this->fileProcessor->findFiles($testDir, ['php']);
        if (empty($files)) {
            $this->showProgress("ã‚¨ãƒ©ãƒ¼: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
            return ['success' => false, 'message' => 'ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'];
        }
        
        // ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
        $this->showProgress("ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ");
        foreach ($files as $index => $file) {
            $this->showProgress("  " . ($index + 1) . ". " . basename($file));
        }
        
        $testResults = [];
        $successCount = 0;
        $queryCount = 0;
        $crudCounts = ['C' => 0, 'R' => 0, 'U' => 0, 'D' => 0];
        $tableStats = [];
        $startTime = microtime(true);
        
        // å„ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
        foreach ($files as $filePath) {
            $filename = basename($filePath);
            $fileStartTime = microtime(true);
            $this->showProgress("\nãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­: {$filename}");
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
            $this->analyzeFile($filePath);
            $fileEndTime = microtime(true);
            $fileTime = round(($fileEndTime - $fileStartTime) * 1000, 2); // ãƒŸãƒªç§’å˜ä½
            
            // ãƒ†ã‚¹ãƒˆçµæœã‚’åˆ¤å®š
            $testSuccess = false;
            $testMessage = '';
            $fileQueries = 0;
            $fileTables = 0;
            $fileCrud = ['C' => 0, 'R' => 0, 'U' => 0, 'D' => 0];
            
            // çµæœãŒã‚ã‚Œã°ãƒ†ã‚¹ãƒˆæˆåŠŸ
            if (isset($this->results[basename($filePath)])) {
                $testSuccess = true;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã‚¯ã‚¨ãƒªæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                foreach ($this->results[basename($filePath)] as $function => $tables) {
                    $fileTables += count($tables);
                    
                    foreach ($tables as $table => $operations) {
                        $fileQueries += count($operations);
                        
                        // ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆã‚’åé›†
                        if (!isset($tableStats[$table])) {
                            $tableStats[$table] = [
                                'C' => 0, 'R' => 0, 'U' => 0, 'D' => 0,
                                'files' => [], 'isView' => false, 'isTemp' => false
                            ];
                        }
                        
                        // ãƒ•ã‚¡ã‚¤ãƒ«è¿½è·¡
                        if (!in_array($filename, $tableStats[$table]['files'])) {
                            $tableStats[$table]['files'][] = $filename;
                        }
                        
                        // CRUDæ“ä½œã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                        foreach ($operations as $op) {
                            $opType = substr($op, 0, 1);
                            if (in_array($opType, ['C', 'R', 'U', 'D'])) {
                                $fileCrud[$opType]++;
                                $crudCounts[$opType]++;
                                $tableStats[$table][$opType]++;
                            }
                            
                            // ãƒ†ãƒ³ãƒãƒ©ãƒªã‹ãƒ“ãƒ¥ãƒ¼ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                            if (strpos($op, '@temp') !== false) {
                                $tableStats[$table]['isTemp'] = true;
                            }
                            if (strpos($op, '@view') !== false) {
                                $tableStats[$table]['isView'] = true;
                            }
                        }
                    }
                }
                
                $queryCount += $fileQueries;
                $crudSummary = "C:{$fileCrud['C']} R:{$fileCrud['R']} U:{$fileCrud['U']} D:{$fileCrud['D']}";
                $testMessage = "{$fileQueries}å€‹ã®ã‚¯ã‚¨ãƒª, {$fileTables}å€‹ã®ãƒ†ãƒ¼ãƒ–ãƒ« (CRUD: {$crudSummary})";
                $successCount++;
            } else {
                $testSuccess = false;
                $testMessage = 'SQLã‚¯ã‚¨ãƒªãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
            }
            
            // ãƒ†ã‚¹ãƒˆçµæœã‚’è¨˜éŒ²
            $testResults[$filename] = [
                'success' => $testSuccess,
                'message' => $testMessage,
                'queries' => $fileQueries,
                'tables' => $fileTables,
                'crud' => $fileCrud,
                'time' => $fileTime
            ];
            
            $statusMark = $testSuccess ? 'âœ“' : 'âœ—';
            $this->showProgress("{$statusMark} ãƒ†ã‚¹ãƒˆ {$filename}: {$testMessage} ({$fileTime}ms)");
        }
        
        $endTime = microtime(true);
        $totalTime = round(($endTime - $startTime) * 1000, 2); // ãƒŸãƒªç§’å˜ä½
        
        // æˆåŠŸç‡ã‚’è¨ˆç®—
        $totalTests = count($files);
        $successRate = ($totalTests > 0) ? round(($successCount / $totalTests) * 100, 1) : 0;
        
        $this->showProgress("\n===== ãƒ†ã‚¹ãƒˆçµæœã®è¦ç´„ =====");
        $this->showProgress("å®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆ: {$totalTests}");
        $this->showProgress("æˆåŠŸã—ãŸãƒ†ã‚¹ãƒˆ: {$successCount}");
        $this->showProgress("æ¤œå‡ºã•ã‚ŒãŸã‚¯ã‚¨ãƒªæ•°: {$queryCount}");
        $crudSummary = "C:{$crudCounts['C']} R:{$crudCounts['R']} U:{$crudCounts['U']} D:{$crudCounts['D']}";
        $this->showProgress("CRUDæ“ä½œã®åˆè¨ˆ: {$crudSummary}");
        $this->showProgress("æˆåŠŸç‡: {$successRate}%");
        $this->showProgress("å®Ÿè¡Œæ™‚é–“: {$totalTime}ms");
        
        // è©³ç´°ãªãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤º
        $this->showProgress("\n===== è©³ç´°ãªãƒ†ã‚¹ãƒˆçµæœ =====");
        foreach ($testResults as $filename => $result) {
            $status = $result['success'] ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±æ•—';
            $timeInfo = "({$result['time']}ms)";
            $this->showProgress("{$status}: {$filename} - {$result['message']} {$timeInfo}");
        }
        
        // æ¤œå‡ºã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã¨æ“ä½œã‚’è¡¨ç¤º
        $this->showProgress("\n===== æ¤œå‡ºã•ã‚ŒãŸSQLã‚¯ã‚¨ãƒªã¨CRUDæ“ä½œ =====");
        $this->printDetectedTables();
        
        // ãƒ†ã‚¹ãƒˆçµ±è¨ˆã‚’è¿½åŠ å‡ºåŠ›
        $this->showProgress("\n===== ãƒ†ã‚¹ãƒˆçµ±è¨ˆã®è©³ç´° =====");
        $this->showProgress("æœ€ã‚‚å¤šãã®ã‚¯ã‚¨ãƒªã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«: " . $this->findMaxByKey($testResults, 'queries'));
        $this->showProgress("æœ€ã‚‚å¤šãã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«: " . $this->findMaxByKey($testResults, 'tables'));
        $this->showProgress("å‡¦ç†æ™‚é–“ãŒæœ€ã‚‚é•·ã„ãƒ•ã‚¡ã‚¤ãƒ«: " . $this->findMaxByKey($testResults, 'time'));
        
        return [
            'success' => $successCount > 0,
            'testResults' => $testResults,
            'totalTests' => $totalTests,
            'successCount' => $successCount,
            'queryCount' => $queryCount,
            'successRate' => $successRate,
            'crudCounts' => $crudCounts,
            'tableStats' => $tableStats,
            'totalTime' => $totalTime,
            'results' => $this->results
        ];
    }
    
    /**
     * æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ã®å€¤ãŒæœ€å¤§ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
     * 
     * @param array $results ãƒ†ã‚¹ãƒˆçµæœ
     * @param string $key æ¯”è¼ƒã™ã‚‹ã‚­ãƒ¼
     * @return string ãƒ•ã‚¡ã‚¤ãƒ«å
     */
    private function findMaxByKey($results, $key) {
        $maxValue = 0;
        $maxFile = '';
        
        foreach ($results as $filename => $result) {
            if ($result[$key] > $maxValue) {
                $maxValue = $result[$key];
                $maxFile = $filename;
            }
        }
        
        return $maxFile . " ({$maxValue})";
    }
    
    /**
     * æ¤œå‡ºã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã¨æ“ä½œã‚’è¡¨ç¤º
     */
    private function printDetectedTables() {
        if (empty($this->results)) {
            $this->showProgress("æ¤œå‡ºã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        $fileCount = count($this->results);
        $this->showProgress("åˆè¨ˆ {$fileCount} ãƒ•ã‚¡ã‚¤ãƒ«ã§SQLã‚¯ã‚¨ãƒªã‚’æ¤œå‡º: ");
        
        $totalTables = 0;
        $totalQueries = 0;
        $tableStats = [];
        
        foreach ($this->results as $filePath => $functions) {
            $this->showProgress("\nğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: {$filePath}");
            $fileTables = 0;
            $fileQueries = 0;
            
            foreach ($functions as $functionName => $tables) {
                $this->showProgress("  é–¢æ•°: {$functionName}");
                
                foreach ($tables as $tableName => $operations) {
                    $fileTables++;
                    $totalTables++;
                    $fileQueries += count($operations);
                    $totalQueries += count($operations);
                    
                    // ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆã‚’é›†è¨ˆ
                    if (!isset($tableStats[$tableName])) {
                        $tableStats[$tableName] = [
                            'C' => 0, 'R' => 0, 'U' => 0, 'D' => 0, 
                            'files' => [], 'isView' => false, 'isTemp' => false
                        ];
                    }
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«è¿½è·¡
                    if (!in_array($filePath, $tableStats[$tableName]['files'])) {
                        $tableStats[$tableName]['files'][] = $filePath;
                    }
                    
                    $operationsStr = implode(',', $operations);
                    $isView = strpos($operationsStr, '@view') !== false;
                    $isTemp = strpos($operationsStr, '@temp') !== false;
                    
                    if ($isView) {
                        $tableStats[$tableName]['isView'] = true;
                    }
                    
                    if ($isTemp) {
                        $tableStats[$tableName]['isTemp'] = true;
                    }
                    
                    // å„æ“ä½œã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                    foreach ($operations as $op) {
                        $opType = substr($op, 0, 1);
                        if (in_array($opType, ['C', 'R', 'U', 'D'])) {
                            $tableStats[$tableName][$opType]++;
                        }
                    }
                    
                    // æ“ä½œã‚¿ã‚¤ãƒ—ã¨ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    $tableType = $isView ? "ğŸ“Š" : ($isTemp ? "â±ï¸" : "ğŸ“‹");
                    $notes = [];
                    if ($isView) $notes[] = '@view';
                    if ($isTemp) $notes[] = '@temp';
                    $notesStr = !empty($notes) ? " (" . implode(', ', $notes) . ")" : '';
                    
                    $this->showProgress("    {$tableType} ãƒ†ãƒ¼ãƒ–ãƒ«: {$tableName}{$notesStr} - æ“ä½œ: {$operationsStr}");
                }
            }
            
            $this->showProgress("  -- {$filePath} å†…ã§ {$fileTables} ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã™ã‚‹ {$fileQueries} ä»¶ã®ã‚¯ã‚¨ãƒªã‚’æ¤œå‡º");
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆã®è¦ç´„è¡¨ç¤º
        $this->showProgress("\n===== ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆã®è¦ç´„ =====");
        $this->showProgress("åˆè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«æ•°: {$totalTables} (ãƒ¦ãƒ‹ãƒ¼ã‚¯: " . count($tableStats) . ")");
        $this->showProgress("åˆè¨ˆã‚¯ã‚¨ãƒªæ•°: {$totalQueries}");
        
        // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®è©³ç´°çµ±è¨ˆ
        $this->showProgress("\n----- ãƒ†ãƒ¼ãƒ–ãƒ«åˆ¥çµ±è¨ˆ -----");
        foreach ($tableStats as $tableName => $stats) {
            $tableType = $stats['isView'] ? "ğŸ“Š" : ($stats['isTemp'] ? "â±ï¸" : "ğŸ“‹");
            $typeLabel = $stats['isView'] ? " (ãƒ“ãƒ¥ãƒ¼)" : ($stats['isTemp'] ? " (ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«)" : "");
            $this->showProgress("{$tableType} {$tableName}{$typeLabel}:");
            $this->showProgress("  CRUDæ“ä½œ: C:{$stats['C']} R:{$stats['R']} U:{$stats['U']} D:{$stats['D']}");
            $this->showProgress("  åˆ©ç”¨ãƒ•ã‚¡ã‚¤ãƒ«æ•°: " . count($stats['files']));
        }
    }
    
    /**
     * é€²æ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
     * 
     * @param string $message ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    private function showProgress($message) {
        $this->fileProcessor->showProgress($message);
    }
    
    /**
     * çµæœã‚’å–å¾—
     * 
     * @return array è§£æçµæœ
     */
    public function getResults() {
        return $this->results;
    }
    
    /**
     * ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—
     * 
     * @return array ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆ
     */
    public function getViews() {
        return $this->views;
    }
} 
