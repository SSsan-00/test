#!/usr/bin/env php
<?php
/**
 * ---------------------------------------------------------------
 *  escape.php  (Improved Edition â€“ å…¨ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ› & å¤‰æ›´ãªã—è¡Œã‚‚ãƒ­ã‚°)
 * ---------------------------------------------------------------
 *  â—† ä¸»ãªå¤‰æ›´ç‚¹ï¼ˆ2025-06-11 æ·±å¤œï¼‰
 *      1. PhpSpreadsheet ã®ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šè¡Œã‚’ **å®Œå…¨å‰Šé™¤**  
 *      2. ã€Œå¤‰æ›´ãŒãªã‹ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚‚ output ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã—  
 *         Excel ã¸ **ã€ŒNO CHANGEã€è¡Œ** ã‚’å¿…ãš 1 è¡Œè¨˜éŒ²  
 * ---------------------------------------------------------------
 */

require_once __DIR__ . '/vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

/* ===============================================================
 *  å®šæ•°
 * =============================================================== */
const TARGET_LHS_VARS      = ['sql', 'query'];
const EXCLUDE_VAR_PATTERNS = ['\\$sql2', '\\$sq2'];

/* ===============================================================
 *  0. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * =============================================================== */

/**
 * é€²æ—ãƒãƒ¼ã‚’è¡¨ç¤º (0-100 %)
 */
function show_progress(int $current, int $total, string $msg = ''): void
{
    static $lastLen = 0;

    $rate = $total === 0 ? 0 : (int)round($current / $total * 100);
    $bar  = str_pad(str_repeat('=', $rate), 100);
    $line = "\r[{$bar}] {$rate}% {$msg}";
    echo $line . str_repeat(' ', max(0, $lastLen - mb_strlen($line)));
    $lastLen = mb_strlen($line);
    if ($current >= $total) echo PHP_EOL;
}

/**
 * å†å¸°çš„ã« *.php / *.inc ã‚’åé›†
 */
function collect_source_files(string $root): array
{
    $it = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($root, FilesystemIterator::SKIP_DOTS)
    );
    $paths = [];
    foreach ($it as $file) {
        if (in_array($file->getExtension(), ['php', 'inc'], true)) {
            $paths[] = $file->getPathname();
        }
    }
    sort($paths);
    return $paths;
}

/**
 * ç›¸å¯¾ãƒ‘ã‚¹ã‚’å–å¾—
 */
function relpath(string $base, string $target): string
{
    return ltrim(str_replace($base, '', $target), DIRECTORY_SEPARATOR);
}

/* ===============================================================
 *  1. ãƒ©ãƒƒãƒ—å‡¦ç†æœ¬ä½“
 * =============================================================== */

/**
 * å¤‰æ›å¯¾è±¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 */
class ConversionContext
{
    public const ASSIGNMENT_RIGHT = 'assignment_right';
    public const HEREDOC          = 'heredoc';
    public const NOWDOC           = 'nowdoc';

    private static array $contexts = [
        self::ASSIGNMENT_RIGHT => true,
        self::HEREDOC          => true,
        self::NOWDOC           => false,
    ];

    public static function isTarget(string $context): bool
    {
        return self::$contexts[$context] ?? false;
    }
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¦å¤‰æ›´å¾Œã‚³ãƒ¼ãƒ‰ã¨ãƒ­ã‚°ã‚’è¿”ã™
 *
 * @return array{processed:string, logRows:array<array{0:string,1:int,2:string,3:string}>}
 */
function process_file(
    string $content,
    string $relPath,
    array  $excludePatterns = EXCLUDE_VAR_PATTERNS,
    array  $lhsTargets      = TARGET_LHS_VARS
): array {
    $varPattern = '/\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])*/u';

    $lines  = explode("\n", $content);
    $total  = count($lines);
    $log    = [];

    $inDoc          = false;
    $docEndLabel    = '';
    $docIsNowDoc    = false;
    $currentContext = null;

    $lhsTargetsLC = array_map('strtolower', $lhsTargets);

    $isInsideSqlFunc = static function (string $line, string $var): bool {
        if (!preg_match_all('/sql[A-Za-z0-9_]*\s*\(/i', $line, $ms, PREG_OFFSET_CAPTURE)) {
            return false;
        }
        foreach ($ms[0] as [, $start]) {
            $open = strpos($line, '(', $start);
            if ($open === false) continue;

            $depth = 0;
            for ($i = $open, $len = strlen($line); $i < $len; $i++) {
                $ch = $line[$i];
                if ($ch === '(')       $depth++;
                elseif ($ch === ')') {
                    $depth--;
                    if ($depth === 0) {
                        $args = substr($line, $open + 1, $i - $open - 1);
                        if (strpos($args, $var) !== false) return true;
                        break;
                    }
                }
            }
        }
        return false;
    };

    foreach ($lines as $idx => &$line) {
        if ($idx % 100 === 0) show_progress($idx, $total, $relPath);

        $originalLine = $line;
        $modifiedLine = $line;

        /* --- (1) ä»£å…¥åˆ¤å®š --- */
        if (preg_match(
            '/^\s*(\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*)(?:\[[^\]]+\])?\s*(=|\.=)\s*(.+)$/u',
            $line,
            $lhsMatch
        )) {
            $lhsName = strtolower(ltrim($lhsMatch[1], '$'));
            if (in_array($lhsName, $lhsTargetsLC, true)) {
                $currentContext = ConversionContext::ASSIGNMENT_RIGHT;
                $modifiedLine   = $lhsMatch[3];
            } else {
                $currentContext = null;
            }
        }

        /* --- (2) HEREDOC/NOWDOC é–‹å§‹ --- */
        if (
            !$inDoc &&
            preg_match(
                '/^\s*(\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*)?\s*(=|\.=)?\s*<<<(?P<q>[\'"]?)(?P<label>[A-Za-z_][A-Za-z0-9_]*)\k<q>/u',
                $line,
                $m
            )
        ) {
            $lhsName        = isset($m[1]) ? strtolower(ltrim($m[1], '$')) : '';
            $docIsTarget    = in_array($lhsName, $lhsTargetsLC, true);
            $inDoc          = true;
            $docEndLabel    = $m['label'];
            $docIsNowDoc    = ($m['q'] === '\'');
            $currentContext = $docIsNowDoc
                ? ConversionContext::NOWDOC
                : ($docIsTarget ? ConversionContext::HEREDOC : null);
        }

        /* --- (3) HEREDOC/NOWDOC çµ‚äº† --- */
        if ($inDoc && preg_match('/^' . preg_quote($docEndLabel, '/') . ';?\s*$/', trim($line))) {
            $inDoc          = false;
            $docEndLabel    = '';
            $docIsNowDoc    = false;
            $currentContext = null;
            continue;
        }

        /* --- (4) å¤‰æ•°ãƒ©ãƒƒãƒ—å‡¦ç† --- */
        if ($currentContext && ConversionContext::isTarget($currentContext)) {
            preg_match_all($varPattern, $modifiedLine, $mVars);
            $candidates = array_unique($mVars[0]);

            foreach ($candidates as $var) {
                /* a) é™¤å¤– */
                foreach ($excludePatterns as $pat) {
                    if (preg_match('/^' . $pat . '$/u', $var)) continue 2;
                }
                /* b) æ—¢ã« sql*() å†…ï¼Ÿ */
                if ($isInsideSqlFunc($modifiedLine, $var)) continue;

                /* c) ãƒ–ãƒ¬ãƒ¼ã‚¹å¤‰æ•° */
                $braced = '\{\$' . preg_quote(ltrim($var, '$'), '/') . '\}';
                if (preg_match('/"' . $braced . '"/u', $modifiedLine)) {
                    $modifiedLine = preg_replace(
                        '/"' . $braced . '"/u',
                        'sqlXXXXX({$0})',
                        $modifiedLine
                    );
                    continue;
                }

                /* d) é€šå¸¸å¤‰æ•° */
                $modifiedLine = preg_replace(
                    '/(?<![A-Za-z0-9_\x80-\xff])' . preg_quote($var, '/') . '(?![A-Za-z0-9_\x80-\xff])/u',
                    'sqlXXXXX(' . $var . ')',
                    $modifiedLine
                );
            }
        }

        /* --- (5) å³è¾ºã‚’æˆ»ã™ --- */
        if ($currentContext === ConversionContext::ASSIGNMENT_RIGHT) {
            $line = preg_replace(
                '/^(\s*\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])?\s*(?:=|\.=)\s*).+$/u',
                '$1' . $modifiedLine,
                $line
            );
        } else {
            $line = $modifiedLine;
        }

        /* --- (6) ãƒ­ã‚° --- */
        if ($originalLine !== $line) {
            $log[] = [$relPath, $idx + 1, $originalLine, $line];
        }
    }

    show_progress($total, $total, $relPath);

    return ['processed' => implode("\n", $lines), 'logRows' => $log];
}

/* ===============================================================
 *  2. Excel ãƒ­ã‚°å‡ºåŠ›
 * =============================================================== */
/* ===============================================================
 *  2. Excel ãƒ­ã‚°å‡ºåŠ›  â˜…FIXED
 * =============================================================== */
function export_excel_log(array $rows): string
{
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
    $logName = 'log_' . date('Ymd_His') . '.xlsx';
    $wb      = new Spreadsheet();
    $ws      = $wb->getActiveSheet();
    $ws->setTitle('Log', false);

    // 1) è¦‹å‡ºã—
    $headers = ['ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹', 'è¡Œç•ªå·', 'å¤‰æ›´å‰', 'å¤‰æ›´å¾Œ'];
    foreach ($headers as $col => $label) {
        $ws->setCellValueByColumnAndRow($col + 1, 1, $label);
    }

    // 2) ãƒ‡ãƒ¼ã‚¿è¡Œ â€• ï¼‘è¡Œãšã¤ â€œæ–‡å­—åˆ—â€ ã¨ã—ã¦æ˜ç¤ºçš„ã«æ›¸ãè¾¼ã‚€
    $rowIdx = 2;                                // æ›¸ãè¾¼ã¿å…ˆ Excel è¡Œ (2 è¡Œç›®ã€œ)
    foreach ($rows as [$path, $lineNum, $before, $after]) {
        // Aåˆ—: ãƒ‘ã‚¹
        $ws->setCellValueExplicitByColumnAndRow(
            1, $rowIdx, $path, DataType::TYPE_STRING
        );
        // Båˆ—: è¡Œç•ªå·ï¼ˆæ•°å€¤ï¼‰
        $ws->setCellValueExplicitByColumnAndRow(
            2, $rowIdx, $lineNum, DataType::TYPE_NUMERIC
        );
        // Cåˆ—: å¤‰æ›´å‰
        $ws->setCellValueExplicitByColumnAndRow(
            3, $rowIdx, $before, DataType::TYPE_STRING
        );
        // Dåˆ—: å¤‰æ›´å¾Œ
        $ws->setCellValueExplicitByColumnAndRow(
            4, $rowIdx, $after, DataType::TYPE_STRING
        );

        $rowIdx++;
    }

    // â˜… æ•°å¼è¨ˆç®—ã‚’å®Œå…¨åœæ­¢ï¼ˆå¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã‚‚é«˜é€Ÿ & ä½™è¨ˆãªè­¦å‘Šã‚’é˜²ãï¼‰
    $wb->getCalculationEngine()->disableCalculationCache();
    $wb->getCalculationEngine()->disableCalculation();

    (new Xlsx($wb))->save($logName);
    $wb->disconnectWorksheets();   // ãƒ¡ãƒ¢ãƒªé–‹æ”¾
    unset($wb);

    return $logName;
}

/* ===============================================================
 *  3. ãƒ¡ã‚¤ãƒ³
 * =============================================================== */
function main(array $argv): void
{
    if (count($argv) < 2) {
        fwrite(STDERR, "ä½¿ç”¨æ–¹æ³•: php escape.php <scan_dir>\n");
        exit(1);
    }

    [, $scanDir] = $argv;
    $scanDir   = realpath($scanDir) ?: $scanDir;
    $outputDir = __DIR__ . '/output';
    if (!is_dir($outputDir)) mkdir($outputDir, 0777, true);

    echo "ğŸ“‚ ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡: {$scanDir}\n";
    $files = collect_source_files($scanDir);
    echo "   â†’ " . count($files) . " ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹\n";

    if (!check_existing_files($outputDir, array_map(fn($f) => relpath($scanDir, $f), $files))) {
        echo "ğŸš« ä¸­æ­¢ã—ã¾ã—ãŸ\n";
        return;
    }

    $allLogs = [];
    $start   = microtime(true);

    foreach ($files as $path) {
        $rel = relpath($scanDir, $path);
        $src = file_get_contents($path);

        ['processed' => $dst, 'logRows' => $rows]
            = process_file($src, $rel, EXCLUDE_VAR_PATTERNS, TARGET_LHS_VARS);

        /* ------ å¤‰æ›´ã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšã‚³ãƒ”ãƒ¼ ------ */
        $outPath = $outputDir . DIRECTORY_SEPARATOR . $rel;
        if (!is_dir(dirname($outPath))) mkdir(dirname($outPath), 0777, true);
        file_put_contents($outPath, $dst);

        /* ------ ãƒ­ã‚° ------ */
        if ($rows) {
            $allLogs = array_merge($allLogs, $rows);
        } else {
            // å¤‰æ›´ãªã—è¡Œã‚’ 1 è¡Œè¿½åŠ  (è¡Œç•ªå· 0, NO CHANGE)
            $allLogs[] = [$rel, 0, '', 'NO CHANGE'];
        }
    }

    /* Excel å‡ºåŠ› */
    echo "\nğŸ“‘ Excel ãƒ­ã‚°ã‚’ä½œæˆä¸­...\n";
    $logName = export_excel_log($allLogs);

    /* çµ‚äº† */
    $elapsed = round(microtime(true) - $start, 2);
    echo "âœ… å®Œäº† (å‡¦ç†æ™‚é–“: {$elapsed}s)\n";
    echo "   ãƒ»å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°   : " . count($files) . "\n";
    echo "   ãƒ»Excel ãƒ­ã‚°        : {$logName}\n";
}

/* ===============================================================
 *  4. å®Ÿè¡Œ
 * =============================================================== */
main($argv);

/* ---------------------------------------------------------------
 *  è£œåŠ©: ä¸Šæ›¸ãç¢ºèª
 * --------------------------------------------------------------- */
function check_existing_files(string $outDir, array $relPaths): bool
{
    $dupes = [];
    foreach ($relPaths as $p) {
        if (is_file($outDir . DIRECTORY_SEPARATOR . $p)) $dupes[] = $p;
    }
    if (!$dupes) return true;

    echo "âš ï¸  æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ (è¨ˆ " . count($dupes) . ")\n";
    foreach ($dupes as $p) echo "   - {$p}\n";
    echo "ä¸Šæ›¸ãã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ (yes/no): ";
    return strtolower(trim(fgets(STDIN))) === 'yes';
}