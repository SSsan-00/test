#!/usr/bin/env php
<?php
/**
 * ---------------------------------------------------------------
 *  escape.php
 * ---------------------------------------------------------------
 *  â—† æ”¹ä¿®ãƒã‚¤ãƒ³ãƒˆï¼ˆ2025-06-12ï¼‰
 *      1. ã€Œif ($cnt==1) $sql = â€¦ã€ã®ã‚ˆã†ãª **è¡Œé ­ä»¥å¤–ã®ä»£å…¥** ã‚‚æ¤œå‡º
 *         â”” æ­£è¦è¡¨ç¾ã‚’è¡Œå…¨ä½“ã«æ‹¡å¼µã—ã€å‰ç½®ã‚³ãƒ¼ãƒ‰ã‚’ prefix ã¨ã—ã¦ä¿æŒ
 *      2. å¤‰æ›´ãŒç„¡ã‹ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¿…ãšã‚³ãƒ”ãƒ¼ã—
 *         Excel ãƒ­ã‚°ã¸ â€œNO CHANGEâ€ ã‚’ 1 è¡Œå‡ºåŠ›ï¼ˆå¾“æ¥é€šã‚Šï¼‰
 * ---------------------------------------------------------------
 */

require_once __DIR__ . '/vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

/* ===============================================================
 *  å®šæ•°
 * =============================================================== */
const TARGET_LHS_VARS      = ['sql', 'query'];   // å·¦è¾ºãŒã“ã‚Œã‚‰ã®å ´åˆã ã‘å³è¾ºãƒ©ãƒƒãƒ—
const EXCLUDE_VAR_PATTERNS = ['\\$sql2', '\\$sq2']; // å®Œå…¨é™¤å¤–ã™ã‚‹å¤‰æ•°

/* ===============================================================
 *  0. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * =============================================================== */

/**
 * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ (0-100 %)
 */
function show_progress(int $current, int $total, string $msg = ''): void
{
    static $lastLen = 0;
    $rate = $total === 0 ? 0 : (int)round($current / $total * 100);
    $bar  = str_pad(str_repeat('=', $rate), 100);
    $line = "\r[{$bar}] {$rate}% {$msg}";
    echo $line . str_repeat(' ', max(0, $lastLen - mb_strlen($line)));
    $lastLen = mb_strlen($line);
    if ($current >= $total) echo PHP_EOL;
}

/**
 * ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã® *.php / *.inc ã‚’å†å¸°å–å¾—
 */
function collect_source_files(string $root): array
{
    $it = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($root, FilesystemIterator::SKIP_DOTS)
    );
    $paths = [];
    foreach ($it as $file) {
        if (in_array($file->getExtension(), ['php', 'inc'], true)) {
            $paths[] = $file->getPathname();
        }
    }
    sort($paths);
    return $paths;
}

/**
 * ç›¸å¯¾ãƒ‘ã‚¹ã¸å¤‰æ›
 */
function relpath(string $base, string $target): string
{
    return ltrim(str_replace($base, '', $target), DIRECTORY_SEPARATOR);
}

/* ===============================================================
 *  1. ãƒ©ãƒƒãƒ—å‡¦ç†æœ¬ä½“
 * =============================================================== */

/**
 * å¤‰æ›å¯¾è±¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 */
class ConversionContext
{
    public const ASSIGNMENT_RIGHT = 'assignment_right';
    public const HEREDOC          = 'heredoc';
    public const NOWDOC           = 'nowdoc';

    private static array $contexts = [
        self::ASSIGNMENT_RIGHT => true,
        self::HEREDOC          => true,
        self::NOWDOC           => false,
    ];

    public static function isTarget(string $context): bool
    {
        return self::$contexts[$context] ?? false;
    }
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ« 1 æœ¬ã‚’å‡¦ç†ã—ã¦å¤‰æ›´å¾Œã‚³ãƒ¼ãƒ‰ã¨ãƒ­ã‚°ã‚’è¿”ã™
 *
 * @return array{processed:string, logRows:array<array{0:string,1:int,2:string,3:string}>}
 */
function process_file(
    string $content,
    string $relPath,
    array  $excludePatterns = EXCLUDE_VAR_PATTERNS,
    array  $lhsTargets      = TARGET_LHS_VARS
): array {
    /* ---------- æº–å‚™ ---------- */
    $varPattern = '/\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])*/u';
    $lhsLC      = array_map('strtolower', $lhsTargets);

    $lines  = explode("\n", $content);
    $total  = count($lines);
    $log    = [];

    $inDoc       = false;
    $docEnd      = '';
    $docIsNow    = false;
    $ctx         = null;

    /**
     * $var ãŒè¡Œä¸­ã§ ã€Œsqlä»»æ„(... )ã€ã®å¼•æ•°ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹åˆ¤å®š
     */
    $insideSql = static function (string $line, string $var): bool {
        if (!preg_match_all('/sql[A-Za-z0-9_]*\s*\(/i', $line, $ms, PREG_OFFSET_CAPTURE)) {
            return false;
        }
        foreach ($ms[0] as [, $start]) {
            $open = strpos($line, '(', $start);
            if ($open === false) continue;

            $depth = 0;
            for ($i = $open, $len = strlen($line); $i < $len; $i++) {
                $ch = $line[$i];
                if ($ch === '(') {
                    $depth++;
                } elseif ($ch === ')') {
                    $depth--;
                    if ($depth === 0) {
                        $args = substr($line, $open + 1, $i - $open - 1);
                        if (strpos($args, $var) !== false) return true;
                        break;
                    }
                }
            }
        }
        return false;
    };

    foreach ($lines as $idx => &$line) {
        if ($idx % 100 === 0) show_progress($idx, $total, $relPath);

        $orig = $line;    // å¤‰æ›´å‰
        $mod  = $line;    // ä½œæ¥­ç”¨

        $assignPrefix = null; // è¡Œé ­ä»¥å¤–ã®ä»£å…¥ç”¨ä¿æŒ

        /* =======================================================
         * (1) ä»£å…¥è¡Œæ¤œå‡º â€• ã€Œif (â€¦) $sql = â€¦ã€ã‚‚æ‹¾ã†
         * ------------------------------------------------------- */
        if (preg_match(
            '/^(.*?\b)(\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])?)\s*(=|\.=)\s*(.+)$/u',
            $line,
            $mAssign
        )) {
            [$full, $prefix, $lhsVar, $op, $rhs] = $mAssign;
            if (in_array(strtolower(ltrim($lhsVar, '$')), $lhsLC, true)) {
                $ctx          = ConversionContext::ASSIGNMENT_RIGHT;
                $mod          = $rhs;                         // å‡¦ç†å¯¾è±¡ã¯å³è¾ºã®ã¿
                $assignPrefix = $prefix . $lhsVar . $op . ' ';
            } else {
                $ctx = null;
            }
        }

        /* =======================================================
         * (2) HEREDOC / NOWDOC é–‹å§‹åˆ¤å®š
         * ------------------------------------------------------- */
        if (
            !$inDoc &&
            preg_match(
                '/^\s*(\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*)?\s*(=|\.=)?\s*<<<(?P<q>[\'"]?)(?P<label>[A-Za-z_][A-Za-z0-9_]*)\k<q>/u',
                $line,
                $mDoc
            )
        ) {
            $lhsName  = isset($mDoc[1]) ? strtolower(ltrim($mDoc[1], '$')) : '';
            $docIsTarget = in_array($lhsName, $lhsLC, true);
            $inDoc    = true;
            $docEnd   = $mDoc['label'];
            $docIsNow = ($mDoc['q'] === '\'');

            $ctx = $docIsNow
                ? ConversionContext::NOWDOC
                : ($docIsTarget ? ConversionContext::HEREDOC : null);
        }

        /* =======================================================
         * (3) HEREDOC / NOWDOC çµ‚äº†åˆ¤å®š
         * ------------------------------------------------------- */
        if ($inDoc && preg_match('/^' . preg_quote($docEnd, '/') . ';?\s*$/', trim($line))) {
            $inDoc = false;
            $docEnd = '';
            $docIsNow = false;
            $ctx = null;
            // çµ‚äº†è¡Œãã®ã‚‚ã®ã¯åŠ å·¥ä¸è¦
            continue;
        }

        /* =======================================================
         * (4) å¤‰æ•°ãƒ©ãƒƒãƒ—å‡¦ç†
         * ------------------------------------------------------- */
        if ($ctx && ConversionContext::isTarget($ctx)) {
            preg_match_all($varPattern, $mod, $mVars);
            $cand = array_unique($mVars[0]);

            foreach ($cand as $v) {
                /* a) é™¤å¤–ãƒªã‚¹ãƒˆ */
                foreach ($excludePatterns as $pat) {
                    if (preg_match('/^' . $pat . '$/u', $v)) continue 2;
                }
                /* b) æ—¢ã« sql*() ã®å¼•æ•°å†…ãªã‚‰ã‚¹ã‚­ãƒƒãƒ— */
                if ($insideSql($mod, $v)) continue;

                /* c) ãƒ–ãƒ¬ãƒ¼ã‚¹ä»˜ãå¤‰æ•° "{$var}" */
                $braced = '\{\$' . preg_quote(ltrim($v, '$'), '/') . '\}';
                if (preg_match('/"' . $braced . '"/u', $mod)) {
                    $mod = preg_replace('/"' . $braced . '"/u', 'sqlXXXXX({$0})', $mod);
                    continue;
                }

                /* d) é€šå¸¸å¤‰æ•°ç½®æ› */
                $mod = preg_replace(
                    '/(?<![A-Za-z0-9_\x80-\xff])' . preg_quote($v, '/') . '(?![A-Za-z0-9_\x80-\xff])/u',
                    'sqlXXXXX(' . $v . ')',
                    $mod
                );
            }
        }

        /* =======================================================
         * (5) è¡Œå†æ§‹ç¯‰
         * ------------------------------------------------------- */
        if ($assignPrefix !== null) {
            $line = $assignPrefix . $mod;
        } else {
            $line = $mod;
        }

        /* =======================================================
         * (6) ãƒ­ã‚°
         * ------------------------------------------------------- */
        if ($orig !== $line) {
            $log[] = [$relPath, $idx + 1, $orig, $line];
        }
    }

    show_progress($total, $total, $relPath);

    return ['processed' => implode("\n", $lines), 'logRows' => $log];
}

/* ===============================================================
 *  2. Excel ãƒ­ã‚°å‡ºåŠ›
 * =============================================================== */
function export_excel_log(array $rows): string
{
    $data    = [['ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹', 'è¡Œç•ªå·', 'å¤‰æ›´å‰', 'å¤‰æ›´å¾Œ']];
    $data    = array_merge($data, $rows);
    $name    = 'log_' . date('Ymd_His') . '.xlsx';

    $wb = new Spreadsheet();
    $ws = $wb->getActiveSheet();
    $ws->fromArray($data, null, 'A1', true);
    $ws->setTitle('Log', false);

    $writer = new Xlsx($wb);
    $writer->setPreCalculateFormulas(false);
    $writer->save($name);

    $wb->disconnectWorksheets();
    unset($wb);

    return $name;
}

/* ===============================================================
 *  3. ãƒ¡ã‚¤ãƒ³
 * =============================================================== */
function main(array $argv): void
{
    if (count($argv) < 2) {
        fwrite(STDERR, "ä½¿ç”¨æ–¹æ³•: php escape.php <scan_dir>\n");
        exit(1);
    }

    [, $scanDir] = $argv;
    $scanDir   = realpath($scanDir) ?: $scanDir;
    $outDir    = __DIR__ . '/output';
    if (!is_dir($outDir)) mkdir($outDir, 0777, true);

    echo "ğŸ“‚ ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡: {$scanDir}\n";
    $files = collect_source_files($scanDir);
    echo "   â†’ " . count($files) . " ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹\n";

    if (!check_existing_files($outDir, array_map(fn($f) => relpath($scanDir, $f), $files))) {
        echo "ğŸš« ä¸­æ­¢ã—ã¾ã—ãŸ\n";
        return;
    }

    $logs  = [];
    $start = microtime(true);

    foreach ($files as $path) {
        $rel = relpath($scanDir, $path);
        $src = file_get_contents($path);

        ['processed' => $dst, 'logRows' => $rows]
            = process_file($src, $rel, EXCLUDE_VAR_PATTERNS, TARGET_LHS_VARS);

        /* --- å‡ºåŠ›å…ˆã«ä¿å­˜ï¼ˆå…¨ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ --- */
        $outPath = $outDir . DIRECTORY_SEPARATOR . $rel;
        if (!is_dir(dirname($outPath))) mkdir(dirname($outPath), 0777, true);
        file_put_contents($outPath, $dst);

        /* --- ãƒ­ã‚° --- */
        $logs = array_merge($logs, $rows ?: [[$rel, 0, '', 'NO CHANGE']]);
    }

    /* --- Excel å‡ºåŠ› --- */
    echo "\nğŸ“‘ Excel ãƒ­ã‚°ã‚’ä½œæˆä¸­...\n";
    $logFile = export_excel_log($logs);

    /* --- çµ‚äº† --- */
    $elapsed = round(microtime(true) - $start, 2);
    echo "âœ… å®Œäº† (å‡¦ç†æ™‚é–“: {$elapsed}s)\n";
    echo "   ãƒ»å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•° : " . count($files) . "\n";
    echo "   ãƒ»Excel ãƒ­ã‚°     : {$logFile}\n";
}
main($argv);

/* ---------------------------------------------------------------
 *  è£œåŠ©: ä¸Šæ›¸ãç¢ºèª
 * --------------------------------------------------------------- */
function check_existing_files(string $outDir, array $relPaths): bool
{
    $dupes = [];
    foreach ($relPaths as $p) {
        if (is_file($outDir . DIRECTORY_SEPARATOR . $p)) $dupes[] = $p;
    }
    if (!$dupes) return true;

    echo "âš ï¸  æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ (è¨ˆ " . count($dupes) . ")\n";
    foreach ($dupes as $p) echo "   - {$p}\n";
    echo "ä¸Šæ›¸ãã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ (yes/no): ";
    return strtolower(trim(fgets(STDIN))) === 'yes';
}