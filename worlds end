#!/usr/bin/env php
<?php
/**
 * ---------------------------------------------------------------
 *  escape.php  (Improved Edition â€“ LHS å¤‰æ•°åãƒ•ã‚£ãƒ«ã‚¿ä»˜ã)
 * ---------------------------------------------------------------
 *  â—† ç›®çš„
 *      ãƒ»"æœªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¤‰æ•°" ã‚’ sqlXXXXX() ã§ãƒ©ãƒƒãƒ—ã—ã¦å®‰å…¨åŒ–
 *      ãƒ»å¤‰æ›´å·®åˆ†ã‚’ Excel (log_YYYYMMDD.xlsx) ã«è¨˜éŒ²
 *
 *  â—† è¿½åŠ æ”¹è‰¯ç‚¹
 *      1. HEREDOC / NOWDOC ã‚’è§£æã—ã€HEREDOC å†…ã®å¤‰æ•°ã‚‚ãƒ©ãƒƒãƒ—
 *         - NOWDOC (<<<'SQL') ã¯ PHP ãŒå¤‰æ•°å±•é–‹ã—ãªã„ â†’ å¤‰æ›ã‚¹ã‚­ãƒƒãƒ—
 *      2. å¤šè¡Œæ–‡å­—åˆ—ã‚’æ­£ã—ãæŠŠæ¡ã€‚é–‹å§‹ï½çµ‚äº†ãƒ©ãƒ™ãƒ«é–“ã‚’
 *         ã²ã¨ã‹ãŸã¾ã‚Šã®ã€Œè«–ç†è¡Œã€ã¨ã—ã¦å‡¦ç†
 *      3. å¤‰æ•°åã®éƒ¨åˆ†ä¸€è‡´èª¤å¤‰æ›ã‚’ã•ã‚‰ã«å³æ ¼ã«é˜²æ­¢
 *      4. å‡¦ç†é–¢æ•°ã‚’ç´°åˆ†åŒ–ã—ã€å¯èª­æ€§ãƒ»ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã‚’å‘ä¸Š
 *      5. **ï¼ˆNew! 2025-06-11ï¼‰**  
 *         ä»£å…¥ã®å·¦è¾ºãŒ `$sql` ã¾ãŸã¯ `$query` ã®ã¨ãã ã‘å³è¾ºã‚’ãƒ©ãƒƒãƒ—ã€‚  
 *         å·¦è¾ºå¤‰æ•°åã¯é…åˆ— `TARGET_LHS_VARS` ã‚’ç·¨é›†ã™ã‚‹ã ã‘ã§å¤‰æ›´å¯èƒ½
 *
 *  â—† ä½¿ã„æ–¹
 *      $ php escape.php <scan_dir>
 *
 *  ---------------------------------------------------------------
 */

require_once __DIR__ . '/vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

/**
 * ---------------------------------------------------------------
 *  ãƒ©ãƒƒãƒ—å¯¾è±¡ã¨ãªã‚‹ã€Œå·¦è¾ºå¤‰æ•°åã€ï¼ˆ$ ã‚’é™¤ã„ãŸåå‰ï¼‰ã‚’å®šç¾©
 *    - ã“ã“ã‚’ç·¨é›†ã™ã‚‹ã ã‘ã§ç°¡å˜ã«å¢—æ¸›ã§ãã‚‹
 *    - å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã¯åŒºåˆ¥ã—ã¾ã›ã‚“
 * ---------------------------------------------------------------
 */
const TARGET_LHS_VARS = ['sql', 'query'];

/* ===============================================================
 *  0.  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * =============================================================== */

/**
 * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ 0-100% ã§è¡¨ç¤º
 */
function show_progress(int $current, int $total, string $msg = ''): void
{
    static $lastLen = 0;

    $rate = $total === 0 ? 0 : (int)round($current / $total * 100);
    $bar  = str_pad(str_repeat('=', $rate), 100);
    $line = "\r[{$bar}] {$rate}% {$msg}";
    echo $line . str_repeat(' ', max(0, $lastLen - mb_strlen($line)));
    $lastLen = mb_strlen($line);
    if ($current >= $total) echo PHP_EOL;
}

/**
 * å†å¸°çš„ã« *.php / *.inc ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†
 */
function collect_source_files(string $root): array
{
    $it = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($root, FilesystemIterator::SKIP_DOTS)
    );
    $paths = [];
    foreach ($it as $file) {
        if (in_array($file->getExtension(), ['php', 'inc'], true)) {
            $paths[] = $file->getPathname();
        }
    }
    sort($paths);
    return $paths;
}

/**
 * $target ã‚’ $base ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã¸å¤‰æ›
 */
function relpath(string $base, string $target): string
{
    return ltrim(str_replace($base, '', $target), DIRECTORY_SEPARATOR);
}

/* ===============================================================
 *  1.  å¤‰æ•°ãƒ©ãƒƒãƒ—å‡¦ç†æœ¬ä½“
 * =============================================================== */

/**
 * å¤‰æ›å¯¾è±¡ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å®šç¾©
 */
class ConversionContext {
    public const ASSIGNMENT_RIGHT = 'assignment_right';  // ä»£å…¥ã®å³è¾º
    public const HEREDOC         = 'heredoc';            // ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…
    public const NOWDOC          = 'nowdoc';             // ãƒŠã‚¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ï¼ˆå‡¦ç†å¯¾è±¡å¤–ï¼‰

    private static array $contexts = [
        self::ASSIGNMENT_RIGHT => true,  // å‡¦ç†å¯¾è±¡
        self::HEREDOC          => true,  // å‡¦ç†å¯¾è±¡
        self::NOWDOC           => false, // å‡¦ç†å¯¾è±¡å¤–
    ];

    public static function isTarget(string $context): bool
    {
        return self::$contexts[$context] ?? false;
    }

    public static function addContext(string $context, bool $isTarget = true): void
    {
        self::$contexts[$context] = $isTarget;
    }
}

/**
 * 1 ãƒ•ã‚¡ã‚¤ãƒ«åˆ†ã®ç½®æ›ã‚’è¡Œã„ã€å¤‰æ›´è¡Œã‚’ãƒ­ã‚°ã«æ ¼ç´ã—ã¦è¿”ã™
 *
 * @param string $content          å‡¦ç†å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹
 * @param string $relPath          ãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ï¼ˆãƒ­ã‚°ç”¨ï¼‰
 * @param array  $excludePatterns  ãƒ©ãƒƒãƒ—é™¤å¤–å¤‰æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ­£è¦è¡¨ç¾ï¼‰
 * @param array  $lhsTargets       ä»£å…¥å·¦è¾ºãŒå¯¾è±¡ã¨ãªã‚‹å¤‰æ•°åãƒªã‚¹ãƒˆ
 *
 * @return array{
 *     processed:string,
 *     logRows:array<array{0:string,1:int,2:string,3:string}>
 * }
 */
function process_file(
    string $content,
    string $relPath,
    array  $excludePatterns = [],
    array  $lhsTargets      = TARGET_LHS_VARS
): array {
    /* ---------- æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ ---------- */
    //   $foo, $arr['x'], $_POST['id'] ãªã©
    $varPattern = '/\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])*/u';

    /* ---------- è¡Œãƒ™ãƒ¼ã‚¹ã®è§£æ ---------- */
    $lines = explode("\n", $content);
    $total = count($lines);
    $log   = [];

    // çŠ¶æ…‹ä¿æŒç”¨ãƒ•ãƒ©ã‚°
    $inDoc          = false;  // HEREDOC/NOWDOC å†…ã‹
    $docEndLabel    = '';     // HEREDOC çµ‚äº†ãƒ©ãƒ™ãƒ«
    $docIsNowDoc    = false;  // NOWDOC ãƒ•ãƒ©ã‚°
    $docIsTarget    = false;  // HEREDOC ãŒå¯¾è±¡ã‹ã©ã†ã‹
    $currentContext = null;   // ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

    // æ¯”è¼ƒç”¨ã«å·¦è¾ºå¤‰æ•°åã‚’å°æ–‡å­—åŒ–
    $lhsTargetsLC = array_map('strtolower', $lhsTargets);

    foreach ($lines as $idx => &$line) {
        // 100 è¡Œã”ã¨ã«é€²æ—è¡¨ç¤º
        if ($idx % 100 === 0) show_progress($idx, $total, $relPath);

        $originalLine = $line;   // ãƒ­ã‚°ç”¨
        $modifiedLine = $line;   // å¤‰æ›ç”¨

        /* =======================================================
         * (1) ä»£å…¥è¡Œã®åˆ¤å®š
         * ------------------------------------------------------- */
        $lhsMatch = [];
        if (preg_match(
            '/^\s*(\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*)(?:\[[^\]]+\])?' . // $var or $arr[...]
            '\s*(=|\.=)\s*(.+)$/u',
            $line,
            $lhsMatch
        )) {
            $lhsVarName = strtolower(ltrim($lhsMatch[1], '$'));

            if (in_array($lhsVarName, $lhsTargetsLC, true)) {
                $currentContext = ConversionContext::ASSIGNMENT_RIGHT;  // å³è¾ºã‚’å‡¦ç†
                $modifiedLine   = $lhsMatch[3];                         // å³è¾ºã®ã¿æŠ½å‡º
            } else {
                $currentContext = null; // å¯¾è±¡å¤–
            }
        }

        /* =======================================================
         * (2) HEREDOC / NOWDOC é–‹å§‹åˆ¤å®š
         * ------------------------------------------------------- */
        if (
            !$inDoc &&
            preg_match(
                '/^\s*(\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*)?\s*(=|\.=)?\s*<<<(?P<quote>[\'"]?)(?P<label>[A-Za-z_][A-Za-z0-9_]*)\k<quote>/u',
                $line,
                $m
            )
        ) {
            $lhsName     = isset($m[1]) ? strtolower(ltrim($m[1], '$')) : '';
            $docIsTarget = in_array($lhsName, $lhsTargetsLC, true);
            $inDoc       = true;
            $docEndLabel = $m['label'];
            $docIsNowDoc = ($m['quote'] === '\'');

            $currentContext = $docIsNowDoc
                ? ConversionContext::NOWDOC
                : ($docIsTarget ? ConversionContext::HEREDOC : null);
        }

        /* =======================================================
         * (3) HEREDOC / NOWDOC çµ‚äº†åˆ¤å®š
         * ------------------------------------------------------- */
        if ($inDoc && preg_match('/^' . preg_quote($docEndLabel, '/') . ';?\s*$/', trim($line))) {
            $inDoc          = false;
            $docEndLabel    = '';
            $docIsNowDoc    = false;
            $docIsTarget    = false;
            $currentContext = null;
            continue;   // çµ‚äº†è¡Œè‡ªä½“ã¯åŠ å·¥ä¸è¦
        }

        /* =======================================================
         * (4) ãƒ©ãƒƒãƒ—å‡¦ç†ï¼ˆå¯¾è±¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰
         * ------------------------------------------------------- */
        if ($currentContext && ConversionContext::isTarget($currentContext)) {
            // 1 è¡Œå†…ã®å¤‰æ•°å€™è£œã‚’æŠ½å‡º
            preg_match_all($varPattern, $modifiedLine, $matches);
            $candidates = array_unique($matches[0]);

            foreach ($candidates as $var) {
                /* ---- a) é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ ---- */
                foreach ($excludePatterns as $pat) {
                    if (preg_match('/^' . $pat . '$/u', $var)) {
                        continue 2;   // æ¬¡ã® $var ã¸
                    }
                }

                /* ---- b) æ—¢ã«ãƒ©ãƒƒãƒ—æ¸ˆã¿ï¼Ÿ ---- */
                if (preg_match('/sql\w+\s*\(\s*' . preg_quote($var, '/') . '\s*\)/ui', $modifiedLine)) {
                    continue;
                }

                /* ---- c) ãƒ–ãƒ¬ãƒ¼ã‚¹ä»˜ãå¤‰æ•° "{$var}" ---- */
                $braced = '\{\$' . preg_quote(ltrim($var, '$'), '/') . '\}';
                if (preg_match('/"' . $braced . '"/u', $modifiedLine)) {
                    $modifiedLine = preg_replace(
                        '/"' . $braced . '"/u',
                        'sqlXXXXX({$0})',   // {$0} = {$var}
                        $modifiedLine
                    );
                    continue;
                }

                /* ---- d) é€šå¸¸å¤‰æ•° $var ---- */
                $modifiedLine = preg_replace(
                    '/(?<![A-Za-z0-9_\x80-\xff])' . preg_quote($var, '/') . '(?![A-Za-z0-9_\x80-\xff])/u',
                    'sqlXXXXX(' . $var . ')',
                    $modifiedLine
                );
            }
        }

        /* =======================================================
         * (5) ä»£å…¥è¡Œã®å³è¾ºã‚’å…ƒã®è¡Œã«æˆ»ã™
         * ------------------------------------------------------- */
        if ($currentContext === ConversionContext::ASSIGNMENT_RIGHT) {
            $line = preg_replace(
                '/^(\s*\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])?\s*(?:=|\.=)\s*).+$/u',
                '$1' . $modifiedLine,
                $line
            );
        } else {
            $line = $modifiedLine;
        }

        /* =======================================================
         * (6) ãƒ­ã‚°è¨˜éŒ²
         * ------------------------------------------------------- */
        if ($originalLine !== $line) {
            $log[] = [$relPath, $idx + 1, $originalLine, $line];
        }
    } // è¡Œãƒ«ãƒ¼ãƒ—çµ‚äº†

    // é€²æ—å®Œäº†è¡¨ç¤º
    show_progress($total, $total, $relPath);

    return [
        'processed' => implode("\n", $lines),
        'logRows'   => $log,
    ];
}

/* ===============================================================
 *  2.  CLI ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 * =============================================================== */

function main(array $argv): void
{
    if (count($argv) < 2) {
        fwrite(STDERR, "ä½¿ç”¨æ–¹æ³•: php escape.php <scan_dir>\n");
        exit(1);
    }

    [$self, $scanDir] = $argv;
    $scanDir   = realpath($scanDir) ?: $scanDir;
    $outputDir = __DIR__ . '/output';
    if (!is_dir($outputDir)) mkdir($outputDir, 0777, true);

    /* ---------- åé›† ---------- */
    echo "ğŸ“‚ ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡: {$scanDir}\n";
    $files = collect_source_files($scanDir);
    echo "   â†’ " . count($files) . " ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹\n";

    /* ---------- ä¸Šæ›¸ãç¢ºèª ---------- */
    $relFiles  = array_map(fn($f) => relpath($scanDir, $f), $files);
    $overwrite = check_existing_files($outputDir, $relFiles);
    if (!$overwrite) {
        echo "ğŸš« ä¸­æ­¢ã—ã¾ã—ãŸ\n";
        return;
    }

    /* ---------- ç½®æ›å‡¦ç† ---------- */
    $start   = microtime(true);
    $allLogs = [];

    foreach ($files as $path) {
        $rel = relpath($scanDir, $path);
        $src = file_get_contents($path);

        ['processed' => $dst, 'logRows' => $rows]
            = process_file($src, $rel, [], TARGET_LHS_VARS); // â˜… ç¬¬4å¼•æ•°ã«å¯¾è±¡å¤‰æ•°ãƒªã‚¹ãƒˆ

        if ($rows) {
            // å‡ºåŠ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
            $outPath = $outputDir . DIRECTORY_SEPARATOR . $rel;
            if (!is_dir(dirname($outPath))) {
                mkdir(dirname($outPath), 0777, true);
            }
            file_put_contents($outPath, $dst);
            $allLogs = array_merge($allLogs, $rows);
        }
    }

    /* ---------- Excel ãƒ­ã‚° ---------- */
    echo "\nğŸ“‘ Excel ãƒ­ã‚°ã‚’ä½œæˆä¸­...\n";
    $book  = new Spreadsheet();
    $sheet = $book->getActiveSheet();
    $sheet->fromArray(
        ['ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹', 'è¡Œç•ªå·', 'å¤‰æ›´å‰', 'å¤‰æ›´å¾Œ'],
        null,
        'A1'
    );
    foreach ($allLogs as $i => [$f, $l, $b, $a]) {
        $sheet->fromArray([$f, $l, $b, $a], null, 'A' . ($i + 2));
    }
    $logName = 'log_' . date('Ymd_His') . '.xlsx';
    (new Xlsx($book))->save($logName);

    /* ---------- çµ‚äº†é€šçŸ¥ ---------- */
    $elapsed = round(microtime(true) - $start, 2);
    echo "âœ… å®Œäº† (å‡¦ç†æ™‚é–“: {$elapsed}s)\n";
    echo "   ãƒ»å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°: " . count(array_unique(array_column($allLogs, 0))) . "\n";
    echo "   ãƒ»Excel ãƒ­ã‚°        : {$logName}\n";
}

/* ===============================================================
 *  å®Ÿè¡Œ
 * =============================================================== */
main($argv);

/* ---------------------------------------------------------------
 *  è£œåŠ©é–¢æ•°  : check_existing_files
 * --------------------------------------------------------------- */
function check_existing_files(string $outDir, array $relPaths): bool
{
    $dupes = [];
    foreach ($relPaths as $p) {
        $outPath = $outDir . DIRECTORY_SEPARATOR . $p;
        if (is_file($outPath)) $dupes[] = $p;
    }
    if (!$dupes) return true;

    echo "âš ï¸  æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ (è¨ˆ " . count($dupes) . ")\n";
    foreach ($dupes as $p) echo "   - {$p}\n";
    echo "ä¸Šæ›¸ãã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ (yes/no): ";
    $ans = trim(fgets(STDIN));
    return strtolower($ans) === 'yes';
}