#!/usr/bin/env php
<?php
/**
 * ---------------------------------------------------------------
 *  escape.php  (Improved Edition)
 * ---------------------------------------------------------------
 *  â—† ç›®çš„
 *      ãƒ»"æœªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¤‰æ•°" ã‚’ sqlXXXXX() ã§ãƒ©ãƒƒãƒ—ã—ã¦å®‰å…¨åŒ–
 *      ãƒ»å¤‰æ›´å·®åˆ†ã‚’ Excel (log_YYYYMMDD.xlsx) ã«è¨˜éŒ²
 *
 *  â—† è¿½åŠ æ”¹è‰¯ç‚¹ (2025-06-09)
 *      1. HEREDOC / NOWDOC ã‚’è§£æã—ã€HEREDOC å†…ã®å¤‰æ•°ã‚‚ãƒ©ãƒƒãƒ—
 *         - NOWDOC (<<<'SQL') ã¯ PHP ãŒå¤‰æ•°å±•é–‹ã—ãªã„ â†’ å¤‰æ›ã‚¹ã‚­ãƒƒãƒ—
 *      2. å¤šè¡Œæ–‡å­—åˆ—ã‚’æ­£ã—ãæŠŠæ¡ã€‚é–‹å§‹ï½çµ‚äº†ãƒ©ãƒ™ãƒ«é–“ã‚’
 *         ã²ã¨ã‹ãŸã¾ã‚Šã®ã€Œè«–ç†è¡Œã€ã¨ã—ã¦å‡¦ç†
 *      3. å¤‰æ•°åã®éƒ¨åˆ†ä¸€è‡´èª¤å¤‰æ›ã‚’ã•ã‚‰ã«å³æ ¼ã«é˜²æ­¢
 *      4. å‡¦ç†é–¢æ•°ã‚’ç´°åˆ†åŒ–ã—ã€å¯èª­æ€§ãƒ»ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã‚’å‘ä¸Š
 *
 *  â—† ä½¿ã„æ–¹
 *      $ php escape.php <scan_dir>
 *
 *  @author SS
 * ---------------------------------------------------------------
 */

require_once __DIR__ . '/vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

/* ===============================================================
 *  0.  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * =============================================================== */

/**
 * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ 0-100% ã§è¡¨ç¤º
 */
function show_progress(int $current, int $total, string $msg = ''): void
{
    static $lastLen = 0;

    $rate = $total === 0 ? 0 : (int)round($current / $total * 100);
    $bar  = str_pad(str_repeat('=', $rate), 100);
    $line = "\r[{$bar}] {$rate}% {$msg}";
    echo $line . str_repeat(' ', max(0, $lastLen - mb_strlen($line)));
    $lastLen = mb_strlen($line);
    if ($current >= $total) echo PHP_EOL;
}

/**
 * å†å¸°çš„ã« *.php / *.inc ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†
 */
function collect_source_files(string $root): array
{
    $it = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($root, FilesystemIterator::SKIP_DOTS)
    );
    $paths = [];
    foreach ($it as $file) {
        if (\in_array($file->getExtension(), ['php', 'inc'], true)) {
            $paths[] = $file->getPathname();
        }
    }
    sort($paths);
    return $paths;
}

/**
 * $target ã‚’ $base ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã¸å¤‰æ›
 */
function relpath(string $base, string $target): string
{
    return ltrim(str_replace($base, '', $target), DIRECTORY_SEPARATOR);
}

/* ===============================================================
 *  1.  å¤‰æ•°ãƒ©ãƒƒãƒ—å‡¦ç†æœ¬ä½“
 * =============================================================== */

/**
 * å¤‰æ›å¯¾è±¡ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å®šç¾©
 */
class ConversionContext {
    public const ASSIGNMENT_RIGHT = 'assignment_right';  // ä»£å…¥ã®å³è¾º
    public const HEREDOC = 'heredoc';                    // ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…
    public const NOWDOC = 'nowdoc';                      // ãƒŠã‚¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ï¼ˆå‡¦ç†å¯¾è±¡å¤–ï¼‰

    private static array $contexts = [
        self::ASSIGNMENT_RIGHT => true,  // å‡¦ç†å¯¾è±¡
        self::HEREDOC => true,          // å‡¦ç†å¯¾è±¡
        self::NOWDOC => false,          // å‡¦ç†å¯¾è±¡å¤–
    ];

    public static function isTarget(string $context): bool {
        return self::$contexts[$context] ?? false;
    }

    public static function addContext(string $context, bool $isTarget = true): void {
        self::$contexts[$context] = $isTarget;
    }
}

/**
 * 1 ãƒ•ã‚¡ã‚¤ãƒ«åˆ†ã®ç½®æ›ã‚’è¡Œã„ã€å¤‰æ›´è¡Œã‚’ãƒ­ã‚°ã«æ ¼ç´ã—ã¦è¿”ã™
 *
 * @return array{processed:string, logRows:array<array{0:string,1:int,2:string,3:string}>}
 */
function process_file(
    string $content,
    string $relPath,
    array  $excludePatterns = []
): array {
    // ---------- æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æº–å‚™ ----------
    //   $foo, $arr['x'], $_POST['id'] ãªã©
    $varPattern = '/\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])*/u';

    // ---------- è¡Œãƒ™ãƒ¼ã‚¹ã®è§£æ ----------
    $lines  = explode("\n", $content);
    $total  = \count($lines);
    $log    = [];

    $inDoc  = false;              // HEREDOC / NOWDOCå†…éƒ¨ã‹ã©ã†ã‹
    $docEnd = '';                 // çµ‚äº†ãƒ©ãƒ™ãƒ«
    $docIsNow = false;            // NOWDOC ãƒ•ãƒ©ã‚°
    $currentContext = null;       // ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

    foreach ($lines as $idx => &$line) {
        // 100è¡Œã”ã¨ã«é€²æ—è¡¨ç¤º
        if ($idx % 100 === 0) show_progress($idx, $total, $relPath);

        $originalLine = $line;
        $modifiedLine = $line;

        /* ---- (1) ä»£å…¥ã®å³è¾ºåˆ¤å®š ---- */
        if (preg_match('/^\s*\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])*\s*(?:=|\.=)\s*(.+)$/u', $line, $m)) {
            $currentContext = ConversionContext::ASSIGNMENT_RIGHT;
            $modifiedLine = $m[1]; // ä»£å…¥ã®å³è¾ºã®ã¿ã‚’å‡¦ç†
        }

        /* ---- (2) HEREDOC/NOWDOC é–‹å§‹åˆ¤å®š ---- */
        if (!$inDoc &&
            preg_match('/<<<(?P<quote>[\'"]?)(?P<label>[A-Za-z_][A-Za-z0-9_]*)\k<quote>/', $line, $m)
        ) {
            $inDoc     = true;
            $docEnd    = $m['label'];
            $docIsNow  = ($m['quote'] === '\''); // quote ãŒ ' â†’ NOWDOC
            $currentContext = $docIsNow ? ConversionContext::NOWDOC : ConversionContext::HEREDOC;
        }

        /* ---- (3) HEREDOC/NOWDOC çµ‚äº†åˆ¤å®š ---- */
        if ($inDoc && preg_match("/^{$docEnd};?\s*$/", trim($line))) {
            $inDoc = false;
            $docEnd = '';
            $docIsNow = false;
            $currentContext = null;
            continue;
        }

        /* ---- (4) å¤‰æ›å¯¾è±¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã®ã¿å‡¦ç† ---- */
        if ($currentContext && ConversionContext::isTarget($currentContext)) {
            /* ---- (4-1) 1 è¡Œå†…ã®å¤‰æ•°å€™è£œã‚’æŠ½å‡º ---- */
            preg_match_all($varPattern, $modifiedLine, $matches);
            $candidates = array_unique($matches[0]);

            foreach ($candidates as $var) {
                // a) é™¤å¤–ãƒªã‚¹ãƒˆ
                foreach ($excludePatterns as $pat) {
                    if (preg_match('/^' . $pat . '$/u', $var)) {
                        continue 2;   // å¤–å´ foreach ($candidates...) ã¸
                    }
                }

                // b) æ—¢ã« sql*() ã§åŒ…ã¾ã‚Œã¦ã„ã‚‹ï¼Ÿ
                $alreadyWrapped = preg_match(
                    '/sql\w+\s*\(\s*' . preg_quote($var, '/') . '\s*\)/ui',
                    $modifiedLine
                );
                if ($alreadyWrapped) continue;

                /* ---- (4-2) ãƒ–ãƒ¬ãƒ¼ã‚¹ä»˜ãå¤‰æ•° "{$var}" ã¸ã®ç‰¹åˆ¥å¯¾å¿œ ---- */
                $braced = '\{\$' . preg_quote(ltrim($var, '$'), '/') . '\}';
                if (preg_match('/"' . $braced . '"/u', $modifiedLine)) {
                    $modifiedLine = preg_replace(
                        '/"' . $braced . '"/u',
                        'sqlXXXXX({$0})',   // {$0} = {$var}
                        $modifiedLine
                    );
                    continue;
                }

                /* ---- (4-3) é€šå¸¸ã®å¤‰æ•° $var ã‚’ãƒ©ãƒƒãƒ— ---- */
                $modifiedLine = preg_replace(
                    '/(?<![A-Za-z0-9_\x80-\xff])' . preg_quote($var, '/') . '(?![A-Za-z0-9_\x80-\xff])/u',
                    'sqlXXXXX(' . $var . ')',
                    $modifiedLine
                );
            }
        }

        /* ---- (5) ä»£å…¥ã®å³è¾ºã‚’å…ƒã®è¡Œã«æˆ»ã™ ---- */
        if ($currentContext === ConversionContext::ASSIGNMENT_RIGHT) {
            $line = preg_replace(
                '/^\s*(\$[A-Za-z_\x80-\xff][A-Za-z0-9_\x80-\xff]*(?:\[[^\]]+\])*\s*(?:=|\.=)\s*).+$/u',
                '$1' . $modifiedLine,
                $line
            );
        } else {
            $line = $modifiedLine;
        }

        /* ---- (6) ãƒ­ã‚°è¨˜éŒ² ---- */
        if ($originalLine !== $line) {
            $log[] = [$relPath, $idx + 1, $originalLine, $line];
        }
    }
    // é€²æ—å®Œäº†
    show_progress($total, $total, $relPath);

    return ['processed' => implode("\n", $lines), 'logRows' => $log];
}

/* ===============================================================
 *  2.  CLI ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 * =============================================================== */

function main(array $argv): void
{
    if (count($argv) < 2) {
        fwrite(STDERR, "ä½¿ç”¨æ–¹æ³•: php escape.php <scan_dir>\n");
        exit(1);
    }

    [$self, $scanDir] = $argv;
    $scanDir   = realpath($scanDir) ?: $scanDir;
    $outputDir = __DIR__ . '/output';
    if (!is_dir($outputDir)) mkdir($outputDir, 0777, true);

    /* ---------- åé›† ---------- */
    echo "ğŸ“‚ ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡: {$scanDir}\n";
    $files = collect_source_files($scanDir);
    echo "   â†’ " . \count($files) . " ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹\n";

    /* ---------- ä¸Šæ›¸ãç¢ºèª ---------- */
    $relFiles = array_map(fn($f) => relpath($scanDir, $f), $files);
    $overwrite = check_existing_files($outputDir, $relFiles);
    if (!$overwrite) {
        echo "ğŸš« ä¸­æ­¢ã—ã¾ã—ãŸ\n";
        return;
    }

    /* ---------- ç½®æ›å‡¦ç† ---------- */
    $start = microtime(true);
    $allLogs = [];
    foreach ($files as $index => $path) {
        $rel = relpath($scanDir, $path);
        $src = file_get_contents($path);
        ['processed' => $dst, 'logRows' => $rows] = process_file($src, $rel);

        if ($rows) {
            // å‡ºåŠ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
            $outPath = $outputDir . DIRECTORY_SEPARATOR . $rel;
            if (!is_dir(dirname($outPath))) {
                mkdir(dirname($outPath), 0777, true);
            }
            file_put_contents($outPath, $dst);
            $allLogs = array_merge($allLogs, $rows);
        }
    }

    /* ---------- Excel ãƒ­ã‚° ---------- */
    echo "\nğŸ“‘ Excel ãƒ­ã‚°ã‚’ä½œæˆä¸­...\n";
    $book = new Spreadsheet();
    $sheet = $book->getActiveSheet();
    $sheet->fromArray(
        ['ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹', 'è¡Œç•ªå·', 'å¤‰æ›´å‰', 'å¤‰æ›´å¾Œ'],
        null,
        'A1'
    );
    foreach ($allLogs as $i => [$f, $l, $b, $a]) {
        $sheet->fromArray([$f, $l, $b, $a], null, 'A' . ($i + 2));
    }
    $logName = 'log_' . date('Ymd_His') . '.xlsx';
    (new Xlsx($book))->save($logName);

    /* ---------- çµ‚äº†é€šçŸ¥ ---------- */
    $elapsed = round(microtime(true) - $start, 2);
    echo "âœ… å®Œäº† (å‡¦ç†æ™‚é–“: {$elapsed}s)\n";
    echo "   ãƒ»å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°: " . \count(array_unique(array_column($allLogs, 0))) . "\n";
    echo "   ãƒ»Excel ãƒ­ã‚°        : {$logName}\n";
}

/* ===============================================================
 *  å®Ÿè¡Œ
 * =============================================================== */
main($argv);


/* ---------------------------------------------------------------
 *  è£œåŠ©é–¢æ•°  : check_existing_files
 * --------------------------------------------------------------- */
function check_existing_files(string $outDir, array $relPaths): bool
{
    $dupes = [];
    foreach ($relPaths as $p) {
        $outPath = $outDir . DIRECTORY_SEPARATOR . $p;
        if (is_file($outPath)) $dupes[] = $p;
    }
    if (!$dupes) return true;

    echo "âš ï¸  æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ (è¨ˆ " . count($dupes) . ")\n";
    foreach ($dupes as $p) echo "   - {$p}\n";
    echo "ä¸Šæ›¸ãã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ (yes/no): ";
    $ans = trim(fgets(STDIN));
    return strtolower($ans) === 'yes';
}
